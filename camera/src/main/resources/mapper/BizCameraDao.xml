<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shmashine.camera.dao.BizCameraDao">

    <resultMap type="com.shmashine.common.entity.TblCamera" id="TblCameraResultMap">
        <result property="vCameraId" column="v_camera_id" jdbcType="VARCHAR"/>
        <result property="vElevatorId" column="v_elevator_id" jdbcType="VARCHAR"/>
        <result property="vElevatorCode" column="v_elevator_code" jdbcType="VARCHAR"/>
        <result property="iCameraType" column="i_camera_type" jdbcType="INTEGER"/>
        <result property="vSerialNumber" column="v_serial_number" jdbcType="VARCHAR"/>
        <result property="vUsername" column="v_username" jdbcType="VARCHAR"/>
        <result property="vPassword" column="v_password" jdbcType="VARCHAR"/>
        <result property="vCloudNumber" column="v_cloud_number" jdbcType="VARCHAR"/>
        <result property="vHlsUrl" column="v_hls_url" jdbcType="VARCHAR"/>
        <result property="vRtmpUrl" column="v_rtmp_url" jdbcType="VARCHAR"/>
        <result property="vPrivateUrl" column="v_private_url" jdbcType="VARCHAR"/>
        <result property="dtCreateTime" column="dt_create_time" jdbcType="TIMESTAMP"/>
        <result property="dtModifyTime" column="dt_modify_time" jdbcType="TIMESTAMP"/>
        <result property="vCreateUserId" column="v_create_user_id" jdbcType="VARCHAR"/>
        <result property="vModifyUserId" column="v_modify_user_id" jdbcType="VARCHAR"/>
        <result property="iDelFlag" column="i_del_flag" jdbcType="INTEGER"/>
    </resultMap>

    <sql id="table_field">
        v_camera_id
        , v_elevator_id, v_elevator_code, i_camera_type, v_serial_number, v_username, v_password, device_code, v_cloud_number, v_hls_url, v_rtmp_url, v_private_url, dt_create_time, dt_modify_time, v_create_user_id, v_modify_user_id, i_del_flag
    </sql>

    <!--通过主键删除-->
    <delete id="deleteCameraInfoById" parameterType="java.lang.String">
        delete
        from tbl_camera
        where v_camera_id = #{cameraId,jdbcType=VARCHAR}
    </delete>

    <select id="searchElevatorListByPage" resultType="java.util.Map">
        select
        tc.v_camera_id AS vCameraId,
        ele.v_elevator_id AS vElevatorId,
        ele.v_elevator_code AS vElevatorCode,
        tc.i_camera_type AS iCameraType,
        tc.v_serial_number AS vSerialNumber,
        tc.v_username AS vUsername ,
        tc.v_password AS vPassword,
        tc.v_cloud_number AS vCloudNumber,
        tc.v_hls_url AS vHlsUrl,
        tc.v_rtmp_url AS vRtmpUrl,
        tc.v_private_url AS vPrivateUrl,
        tc.dt_create_time AS dtCreateTime,
        tc.dt_modify_time AS dtModifyTime,
        ele.i_on_line AS isOnline,
        tc.v_create_user_id AS vCreateUserId,
        tc.v_modify_user_id AS vModifyUserId,
        ele.i_del_flag AS iDelFlag
        from
        tbl_elevator ele
        left join tbl_camera tc on ele.v_elevator_code = tc.v_elevator_code
        <where>
            ele.i_del_flag = 0
            <if test="searchCamerasModule.elevatorId != null and searchCamerasModule.elevatorId != ''">
                and ele.v_elevator_id = #{searchCamerasModule.elevatorId}
            </if>
            <if test="searchCamerasModule.cameraId != null and searchCamerasModule.cameraId != ''">
                and tc.v_camera_id = #{searchCamerasModule.cameraId}
            </if>
            <if test="searchCamerasModule.elevatorCode != null and searchCamerasModule.elevatorCode != ''">
                and ele.v_elevator_code like CONCAT('%',#{searchCamerasModule.elevatorCode},'%')
            </if>

            <if test="searchCamerasModule.cameraType != null and searchCamerasModule.cameraType != ''">
                and tc.i_camera_type = #{searchCamerasModule.cameraType}
            </if>

            <if test="searchCamerasModule.serialNumber != null and searchCamerasModule.serialNumber != ''">
                and tc.v_serial_number = #{searchCamerasModule.serialNumber}
            </if>

            <if test="searchCamerasModule.cloudNumber!= null and searchCamerasModule.cloudNumber != ''">
                and tc.v_cloud_number = #{searchCamerasModule.cloudNumber}
            </if>

            <if test="searchCamerasModule.isOnline!= null and searchCamerasModule.isOnline != ''">
                and ele.i_on_line = #{searchCamerasModule.isOnline}
            </if>
            <if test="searchCamerasModule.isBound != null and searchCamerasModule.isBound == '0'.toString()">
                and (tc.v_elevator_code is null or tc.v_elevator_code = '')
            </if>

            <if test="searchCamerasModule.isBound != null and searchCamerasModule.isBound == '1'.toString()">
                and tc.v_elevator_code is not null and tc.v_elevator_code != ''
            </if>
        </where>
        ORDER BY ele.dt_create_time desc
    </select>

    <select id="searchCamerasListByPage" resultType="java.util.Map">
        SELECT
        tc.v_camera_id AS vCameraId,
        tc.v_elevator_code AS vElevatorCode,
        te.v_elevator_id AS elevatorId,
        tc.i_camera_type AS iCameraType,
        tc.v_serial_number AS vSerialNumber,
        tc.v_is_activate AS isActivate,
        tc.push_trapped_people_voice AS pushTrappedPeopleVoice,
        tc.v_username AS vUsername,
        tc.v_password AS vPassword,
        tc.device_code AS deviceCode,
        tc.v_cloud_number AS vCloudNumber,
        tc.v_hls_url AS vHlsUrl,
        tc.v_rtmp_url AS vRtmpUrl,
        tc.v_private_url AS vPrivateUrl,
        tc.dt_create_time AS dtCreateTime,
        tc.dt_modify_time AS dtModifyTime,
        tc.v_create_user_id AS vCreateUserId,
        tc.v_modify_user_id AS vModifyUserId,
        tc.online_status AS onlineStatus
        from
        tbl_camera tc
        left join
        tbl_elevator as te
        on
        te.v_elevator_id = tc.v_elevator_id
        <if test="!searchCamerasModule.isAdminFlag">
            left join tbl_sys_user_resource as ur on tc.v_elevator_id = ur.v_resource_id
        </if>

        <where>
            tc.i_del_flag = 0
            <if test="searchCamerasModule.cameraId != null and searchCamerasModule.cameraId != ''">
                and tc.v_camera_id = #{searchCamerasModule.cameraId}
            </if>

            <if test="searchCamerasModule.cameraType != null and searchCamerasModule.cameraType != ''">
                and tc.i_camera_type = #{searchCamerasModule.cameraType}
            </if>

            <if test="searchCamerasModule.serialNumber != null and searchCamerasModule.serialNumber != ''">
                and tc.v_serial_number = #{searchCamerasModule.serialNumber}
            </if>

            <if test="searchCamerasModule.cloudNumber!= null and searchCamerasModule.cloudNumber != ''">
                and tc.v_cloud_number = #{searchCamerasModule.cloudNumber}
            </if>

            <if test="searchCamerasModule.isActivate != null ">
                and tc.v_is_activate = #{searchCamerasModule.isActivate}
            </if>

            <if test="searchCamerasModule.isBound != null and searchCamerasModule.isBound == '0'.toString()">
                and (tc.v_elevator_code is null or tc.v_elevator_code = '')
            </if>

            <if test="searchCamerasModule.isBound != null and searchCamerasModule.isBound == '1'.toString()">
                and tc.v_elevator_code is not null and tc.v_elevator_code != ''
            </if>

            <if test="!searchCamerasModule.isAdminFlag">
                and ur.v_user_id = #{searchCamerasModule.userId}
            </if>
        </where>
        ORDER BY tc.dt_create_time desc
    </select>

    <select id="searchCamerasVedioAndPicByPage" resultType="com.shmashine.camera.model.CamerasResponseModule">
        SELECT
        tc.v_camera_id AS vCameraId,
        tc.i_camera_type AS iCameraType,
        tc.v_cloud_number AS vCloudNumber,
        tc.v_serial_number AS vSerialNumber,
        tc.v_elevator_code AS vElevatorCode,
        tf.v_fault_name AS vFaultName ,
        tsf.v_file_id AS vFileId,
        tsf.v_file_name AS vFileName,
        tsf.v_file_type AS vFileType,
        tsf.v_url AS vUrl,
        tsf.dt_create_time AS dtCreateTime,
        tsf.dt_modify_time AS dtModifyTime
        FROM
        tbl_camera tc
        LEFT JOIN tbl_fault tf ON tc.v_elevator_code = tf.v_elevator_code
        LEFT JOIN tbl_sys_file tsf ON tf.v_fault_id = tsf.v_business_id
        <where>
            tc.i_del_flag = 0
            and tsf.i_business_type = 2
            <if test="searchCamerasModule.cameraId != null and searchCamerasModule.cameraId != ''">
                and tc.v_camera_id = #{searchCamerasModule.cameraId}
            </if>
            <if test="searchCamerasModule.elevatorCode != null and searchCamerasModule.elevatorCode != ''">
                and tc.v_elevator_code like CONCAT('%',#{searchCamerasModule.elevatorCode},'%')
            </if>

            <if test="searchCamerasModule.cameraType != null and searchCamerasModule.cameraType != ''">
                and tc.i_camera_type = #{searchCamerasModule.cameraType}
            </if>

            <if test="searchCamerasModule.serialNumber != null and searchCamerasModule.serialNumber != ''">
                and tc.v_serial_number = #{searchCamerasModule.serialNumber}
            </if>

            <if test="searchCamerasModule.cloudNumber!= null and searchCamerasModule.cloudNumber != ''">
                and tc.v_cloud_number = #{searchCamerasModule.cloudNumber}
            </if>

            <if test="searchCamerasModule.faultId!= null and searchCamerasModule.faultId != ''">
                and tf.v_fault_id = #{searchCamerasModule.faultId}
            </if>

            <if test="searchCamerasModule.fileType!= null and searchCamerasModule.fileType != ''">
                and tsf.v_file_type = #{searchCamerasModule.fileType}
            </if>

        </where>
        ORDER BY
        tsf.dt_create_time DESC
    </select>


    <select id="getRtmpUrlByElevatorCode" resultType="java.lang.String">
        select v_rtmp_url
        from tbl_camera
        where v_elevator_code = #{elevatorCode}
          and i_del_flag = 0
    </select>

    <select id="getHlsUrlByElevatorCode" resultType="java.lang.String">
        select v_hls_url
        from tbl_camera
        where v_elevator_code = #{elevatorCode}
          and i_del_flag = 0
    </select>


    <select id="getByElevatorId" resultType="com.shmashine.common.entity.TblCamera">
        select
        <include refid="table_field"/>
        from tbl_camera
        where
        v_elevator_id = #{elevatorId,jdbcType=VARCHAR} and i_del_flag = 0
    </select>

    <select id="getByCameraId" resultType="com.shmashine.common.entity.TblCamera">
        select
        <include refid="table_field"/>
        from tbl_camera
        where
        v_camera_id = #{vCameraId,jdbcType=VARCHAR}
        and i_del_flag = 0
    </select>


    <select id="getByElevatorCode" resultType="com.shmashine.common.entity.TblCamera">
        select
        <include refid="table_field"/>
        from tbl_camera
        where
        v_elevator_code = #{vElevatorCode,jdbcType=VARCHAR} and i_del_flag = 0
    </select>

    <select id="getByvCloudNumber" resultType="com.shmashine.common.entity.TblCamera">
        select
        <include refid="table_field"/>
        from tbl_camera
        where
        v_cloud_number = #{vCloudNumber,jdbcType=VARCHAR} and i_del_flag = 0
        ORDER BY dt_create_time DESC
    </select>

    <!--根据级联编码获取摄像头信息-->
    <select id="queryCameraInfoByChannelCode" resultType="com.shmashine.common.entity.TblCameraCascadePlatformEntity">
        select cloud_number,
               elevator_code,
               camera_type
        from tbl_camera_cascade_platform
        where channel_code = #{channelCode}
    </select>

    <!--根据电梯编码获取摄像头报警配置ID-->
    <select id="getCameraAlarmConfigByElevatorCode" resultType="java.lang.String">
        SELECT id
        FROM camera_alarm_config
        WHERE elevator_code = #{elevatorCode} limit 1
    </select>


    <!--新增实体属性不为null的列-->
    <insert id="insertCamera" keyProperty="vCameraId" useGeneratedKeys="true"
            parameterType="com.shmashine.common.entity.TblCamera">
        insert into tbl_camera
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="vCameraId != null ">
                v_camera_id,
            </if>
            <if test="vElevatorId != null">
                v_elevator_id,
            </if>
            <if test="vElevatorCode != null">
                v_elevator_code,
            </if>
            <if test="iCameraType != null">
                i_camera_type,
            </if>
            <if test="vSerialNumber != null">
                v_serial_number,
            </if>
            <if test="vUsername != null">
                v_username,
            </if>
            <if test="vPassword != null">
                v_password,
            </if>
            <if test="vCloudNumber != null">
                v_cloud_number,
            </if>
            <if test="vHlsUrl != null">
                v_hls_url,
            </if>
            <if test="vRtmpUrl != null">
                v_rtmp_url,
            </if>
            <if test="vPrivateUrl != null">
                v_private_url,
            </if>
            <if test="dtCreateTime != null">
                dt_create_time,
            </if>
            <if test="dtModifyTime != null">
                dt_modify_time,
            </if>
            <if test="vCreateUserId != null">
                v_create_user_id,
            </if>
            <if test="vModifyUserId != null">
                v_modify_user_id,
            </if>
            <if test="isActivate != null">
                v_is_activate,
            </if>
            <if test="pushTrappedPeopleVoice != null">
                push_trapped_people_voice,
            </if>
            <if test="deviceCode != null">
                device_code,
            </if>
            <if test="iDelFlag != null">
                i_del_flag,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="vCameraId != null">
                #{vCameraId,jdbcType=VARCHAR},
            </if>
            <if test="vElevatorId != null">
                #{vElevatorId,jdbcType=VARCHAR},
            </if>
            <if test="vElevatorCode != null">
                #{vElevatorCode,jdbcType=VARCHAR},
            </if>
            <if test="iCameraType != null">
                #{iCameraType,jdbcType=INTEGER},
            </if>
            <if test="vSerialNumber != null">
                #{vSerialNumber,jdbcType=VARCHAR},
            </if>
            <if test="vUsername != null">
                #{vUsername,jdbcType=VARCHAR},
            </if>
            <if test="vPassword != null">
                #{vPassword,jdbcType=VARCHAR},
            </if>
            <if test="vCloudNumber != null">
                #{vCloudNumber,jdbcType=VARCHAR},
            </if>
            <if test="vHlsUrl != null">
                #{vHlsUrl,jdbcType=VARCHAR},
            </if>
            <if test="vRtmpUrl != null">
                #{vRtmpUrl,jdbcType=VARCHAR},
            </if>
            <if test="vPrivateUrl != null">
                #{vPrivateUrl,jdbcType=VARCHAR},
            </if>
            <if test="dtCreateTime != null">
                #{dtCreateTime,jdbcType=TIMESTAMP},
            </if>
            <if test="dtModifyTime != null">
                #{dtModifyTime,jdbcType=TIMESTAMP},
            </if>
            <if test="vCreateUserId != null">
                #{vCreateUserId,jdbcType=VARCHAR},
            </if>
            <if test="vModifyUserId != null">
                #{vModifyUserId,jdbcType=VARCHAR},
            </if>
            <if test="isActivate != null">
                #{isActivate,jdbcType=INTEGER},
            </if>
            <if test="pushTrappedPeopleVoice != null">
                #{pushTrappedPeopleVoice,jdbcType=INTEGER},
            </if>
            <if test="deviceCode != null">
                #{deviceCode},
            </if>
            <if test="iDelFlag != null">
                #{iDelFlag,jdbcType=INTEGER},
            </if>
        </trim>
    </insert>


    <!--通过主键修改实体属性不为null的列-->
    <update id="updateCamera" parameterType="com.shmashine.common.entity.TblCamera">
        update tbl_camera
        <set>
            <if test="vElevatorId != ''">
                v_elevator_id = #{vElevatorId,jdbcType=VARCHAR},
            </if>
            <if test="vElevatorCode != ''">
                v_elevator_code = #{vElevatorCode,jdbcType=VARCHAR},
            </if>
            <if test="iCameraType != null">
                i_camera_type = #{iCameraType,jdbcType=INTEGER},
            </if>
            <if test="vSerialNumber != null">
                v_serial_number = #{vSerialNumber,jdbcType=VARCHAR},
            </if>
            <if test="vUsername != null">
                v_username = #{vUsername,jdbcType=VARCHAR},
            </if>
            <if test="vPassword != null">
                v_password = #{vPassword,jdbcType=VARCHAR},
            </if>
            <if test="deviceCode != null and deviceCode != '' ">
                device_code = #{deviceCode,jdbcType=VARCHAR},
            </if>
            <if test="vCloudNumber != null">
                v_cloud_number = #{vCloudNumber,jdbcType=VARCHAR},
            </if>
            <if test="vHlsUrl != null">
                v_hls_url = #{vHlsUrl,jdbcType=VARCHAR},
            </if>
            <if test="vRtmpUrl != null">
                v_rtmp_url = #{vRtmpUrl,jdbcType=VARCHAR},
            </if>
            <if test="vPrivateUrl != null">
                v_private_url = #{vPrivateUrl,jdbcType=VARCHAR},
            </if>
            <if test="dtModifyTime != null">
                dt_modify_time = #{dtModifyTime,jdbcType=VARCHAR},
            </if>
            <if test="vCreateUserId != null">
                v_create_user_id = #{vCreateUserId,jdbcType=VARCHAR},
            </if>
            <if test="vModifyUserId != null">
                v_modify_user_id = #{vModifyUserId,jdbcType=VARCHAR},
            </if>
            <if test="isActivate != null">
                v_is_activate = #{isActivate,jdbcType=INTEGER},
            </if>
            <if test="pushTrappedPeopleVoice != null">
                push_trapped_people_voice = #{pushTrappedPeopleVoice,jdbcType=INTEGER},
            </if>
            <if test="iDelFlag != null">
                i_del_flag = #{iDelFlag,jdbcType=INTEGER},
            </if>
        </set>
        where v_camera_id = #{vCameraId,jdbcType=VARCHAR}
    </update>

    <!--电梯绑定修改-->
    <update id="updateElevotorBound" parameterType="com.shmashine.common.entity.TblCamera">
        update tbl_camera
        <set>
            <if test="vElevatorId != null">
                v_elevator_id = #{vElevatorId,jdbcType=VARCHAR},
            </if>
            <if test="vElevatorCode != null">
                v_elevator_code = #{vElevatorCode,jdbcType=VARCHAR},
            </if>
            <if test="iCameraType != null">
                i_camera_type = #{iCameraType,jdbcType=INTEGER},
            </if>
            <if test="vSerialNumber != null">
                v_serial_number = #{vSerialNumber,jdbcType=VARCHAR},
            </if>
            <if test="vUsername != null">
                v_username = #{vUsername,jdbcType=VARCHAR},
            </if>
            <if test="vPassword != null">
                v_password = #{vPassword,jdbcType=VARCHAR},
            </if>
            <if test="vCloudNumber != null">
                v_cloud_number = #{vCloudNumber,jdbcType=VARCHAR},
            </if>
            <if test="vHlsUrl != null">
                v_hls_url = #{vHlsUrl,jdbcType=VARCHAR},
            </if>
            <if test="vRtmpUrl != null">
                v_rtmp_url = #{vRtmpUrl,jdbcType=VARCHAR},
            </if>
            <if test="vPrivateUrl != null">
                v_private_url = #{vPrivateUrl,jdbcType=VARCHAR},
            </if>
            <if test="vCreateUserId != null">
                v_create_user_id = #{vCreateUserId,jdbcType=VARCHAR},
            </if>
            <if test="vModifyUserId != null">
                v_modify_user_id = #{vModifyUserId,jdbcType=VARCHAR},
            </if>
            <if test="isActivate != null">
                v_is_activate = #{isActivate,jdbcType=INTEGER},
            </if>
            <if test="iDelFlag != null">
                i_del_flag = #{iDelFlag,jdbcType=INTEGER},
            </if>
        </set>
        where v_camera_id = #{vCameraId,jdbcType=VARCHAR}
    </update>

</mapper>
