<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.shmashine.pm.api.dao.BizElevatorProjectDao">

    <sql id="table_field">
        v_project_id
        , v_project_name, v_remarks, v_party_a, v_party_contacts_name, v_party_contacts_tel, d_start_time, d_end_time, dt_create_time, dt_modify_time, v_create_user_id, v_modify_user_id, i_del_flag
    </sql>

    <resultMap type="com.shmashine.pm.api.module.project.output.ResultProjectDetail" id="TblProjectResultMap">
        <result property="vProjectId" column="v_project_id" jdbcType="VARCHAR"/>
        <result property="vProjectName" column="v_project_name" jdbcType="VARCHAR"/>
        <result property="vDeptId" column="v_dept_id" jdbcType="VARCHAR"/>
        <result property="vDeptName" column="v_dept_name" jdbcType="VARCHAR"/>
        <result property="vRemarks" column="v_remarks" jdbcType="VARCHAR"/>
        <result property="vPartyA" column="v_party_a" jdbcType="VARCHAR"/>
        <result property="vPartyContactsName" column="v_party_contacts_name" jdbcType="VARCHAR"/>
        <result property="vPartyContactsTel" column="v_party_contacts_tel" jdbcType="VARCHAR"/>
        <result property="dStartTime" column="d_start_time" jdbcType="TIMESTAMP"/>
        <result property="dEndTime" column="d_end_time" jdbcType="TIMESTAMP"/>
        <result property="dtCreateTime" column="dt_create_time" jdbcType="TIMESTAMP"/>
        <result property="dtModifyTime" column="dt_modify_time" jdbcType="TIMESTAMP"/>
        <result property="vCreateUserId" column="v_create_user_id" jdbcType="VARCHAR"/>
        <result property="vModifyUserId" column="v_modify_user_id" jdbcType="VARCHAR"/>
        <result property="iDelFlag" column="i_del_flag" jdbcType="INTEGER"/>
    </resultMap>


    <!-- 查找用户能看的项目 列表查询 -->
    <select id="searchElevatorProjectList" resultType="java.util.Map">
        select
        project.v_project_id,
        project.v_project_name,
        project.project_type AS projectType,
        project.v_remarks,
        project.v_party_a,
        project.v_party_contacts_name,
        project.v_party_contacts_tel,
        project.d_start_time,
        project.d_end_time,
        project.dt_create_time,
        project.dt_modify_time,
        project.v_create_user_id,
        project.v_modify_user_id,
        project.i_del_flag,
        project.i_status,
        project.i_village_count,
        case
        when project.i_status = 1 then '进行中'
        when project.i_status = 2 then '已完成'
        else ''
        end as i_status_name,
        min(elevator.i_pm_status) as min_pm_status,
        case
        when min(elevator.i_pm_status) = 1 then '待现勘'
        when min(elevator.i_pm_status) = 2 then '待配货'
        when min(elevator.i_pm_status) = 3 then '待安装'
        when min(elevator.i_pm_status) = 4 then '待调试'
        when min(elevator.i_pm_status) = 5 then '待验收'
        when min(elevator.i_pm_status) = 6 then '运行中'
        when min(elevator.i_pm_status) = 7 then '托管'
        when min(elevator.i_pm_status) = 11 then '现勘中'
        when min(elevator.i_pm_status) = 12 then '配货中'
        when min(elevator.i_pm_status) = 13 then '安装中'
        when min(elevator.i_pm_status) = 14 then '调试中'
        when min(elevator.i_pm_status) = 15 then '验收中'
        else '待现勘'
        end as v_pm_status_name,
        sysinfo.v_name_zh_cn AS i_del_flag_name,
        sysinfo1.v_name_zh_cn AS projectTypeName,
        dept.v_dept_name
        from tbl_project project
        left join tbl_elevator elevator on elevator.v_project_id = project.v_project_id
        and elevator.i_del_flag = 0 and (elevator.v_village_id is not null)
        left join tbl_sys_systeminfo sysinfo on sysinfo.v_sysvalue5 = project.i_del_flag and sysinfo.v_sysid = '10012'
        left join tbl_sys_systeminfo sysinfo1 on sysinfo1.v_sysvalue5 = project.project_type and sysinfo1.v_sysid =
        '10035'
        left join tbl_sys_dept dept on dept.v_dept_id = project.v_dept_id
        <where>
            project.i_del_flag = 0
            <if test="vProjectId != null and vProjectId != ''">
                and project.v_project_id = #{vProjectId,jdbcType=VARCHAR}
            </if>
            <if test="vProjectName != null and vProjectName != ''">
                and project.v_project_name like CONCAT('%',#{vProjectName,jdbcType=VARCHAR},'%')
            </if>
            <if test="vDeptId != null and vDeptId != ''">
                and project.v_dept_id = #{vDeptId,jdbcType=VARCHAR}
            </if>
            <if test="projectType != null ">
                and project.project_type = #{projectType}
            </if>
            <if test="vRemarks != null and vRemarks != ''">
                and project.v_remarks like CONCAT('%',#{vRemarks,jdbcType=VARCHAR},'%')
            </if>
            <if test="vPartyA != null and vPartyA != ''">
                and project.v_party_a like CONCAT('%',#{vPartyA,jdbcType=VARCHAR},'%')
            </if>
            <if test="vPartyContactsName != null and vPartyContactsName != ''">
                and project.v_party_contacts_name like CONCAT('%',#{vPartyContactsName,jdbcType=VARCHAR},'%')
            </if>
            <if test="vPartyContactsTel != null and vPartyContactsTel != ''">
                and project.v_party_contacts_tel like CONCAT('%',#{vPartyContactsTel,jdbcType=VARCHAR},'%')
            </if>
            <if test="!isAdminFlag">
                and project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="vDeptName != null and vDeptName != ''">
                and dept.v_dept_name like concat("%", #{vDeptName}, "%")
            </if>
        </where>
        group by project.v_project_id
        <if test="iStatus != null and iStatus == 1">
            having min_pm_status = #{iStatus, jdbcType=INTEGER} or min_pm_status is null
        </if>
        <if test="iStatus != null and iStatus != 1">
            having min_pm_status = #{iStatus, jdbcType=INTEGER}
        </if>
        order by project.d_end_time desc
    </select>

    <!-- 查找用户能看的项目 列表查询 -->
    <select id="searchElevatorProjectInfo" resultMap="TblProjectResultMap">
        select
        project.v_project_id,
        project.v_project_name,
        project.v_remarks,
        project.project_type,
        project.v_party_a,
        project.v_party_contacts_name,
        project.v_party_contacts_tel,
        project.d_start_time,
        project.d_end_time,
        project.dt_create_time,
        project.dt_modify_time,
        project.v_create_user_id,
        project.v_modify_user_id,
        project.i_del_flag,
        project.i_status,
        count(tbl_village.v_project_id) as i_village_count,
        sysinfo.v_name_zh_cn AS i_del_flag_name,
        project.v_dept_id,
        dept.v_dept_name
        from tbl_project project
        left join tbl_village on tbl_village.v_project_id = project.v_project_id
        left join tbl_sys_systeminfo sysinfo on sysinfo.v_sysvalue5 = project.i_del_flag and sysinfo.v_sysid = '10012'
        left join tbl_sys_dept dept on dept.v_dept_id = project.v_dept_id
        <where>
            project.v_project_id = #{vProjectId} and project.i_del_flag = 0
            <if test="iStatus != null">
                and project.i_status = #{iStatus}
            </if>
            <if test="vDeptIdName != null and vDeptIdName != ''">
                and dept.v_dept_name like concat("%", #{vDeptIdName}, "%")
            </if>
        </where>
        group by project.v_project_id
    </select>

    <!-- 查找用户能看的项目下拉框 是根据部门来的 -->
    <select id="searchElevatorProjectSelectList" resultType="java.util.Map">
        select
        v_project_id,
        v_project_name
        from tbl_project
        <where>
            i_del_flag = 0 and v_dept_id
            <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>

    <!-- 查找用户能看的项目下拉框 是根据部门来的 -->
    <select id="getProjectIdsByDeptIds" resultType="java.lang.String">
        select
        v_project_id
        from tbl_project
        <where>
            i_del_flag = 0 and v_dept_id
            <foreach collection="deptIds" item="item" open="IN(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>

    <select id="getCountByStatus" resultType="java.util.Map">
        select count(tmp.statusName) as count,
	    tmp.min_pm_status,
	    tmp.statusName
        from
            (select
            project.v_project_id, min (elevator.i_pm_status) as min_pm_status, case
            when min (elevator.i_pm_status) in (1, 11) then "现勘"
            when min (elevator.i_pm_status) in (2, 12) then "配货"
            when min (elevator.i_pm_status) in (3, 13) then "安装"
            when min (elevator.i_pm_status) in (4, 14) then "调测"
            when min (elevator.i_pm_status) in (5, 15) then "验收"
            when min (elevator.i_pm_status) = 6 then "运行"
            else "现勘"
            end as statusName
            from
            tbl_project as project
            left join
            tbl_elevator as elevator
            on
            project.v_project_id = elevator.v_project_id
            and elevator.i_del_flag = 0
            and (elevator.v_village_id is not null)
            WHERE
            project.i_del_flag = 0
            group by
            project.v_project_id) as tmp
        group by
            tmp.statusName
    </select>

    <select id="getVillagesStatus" resultType="java.util.Map" parameterType="String">
        select village.i_status       as iStatus,
               case
                   when village.i_status = 1 then '待现勘'
                   when village.i_status = 2 then '待配货'
                   when village.i_status = 3 then '待安装'
                   when village.i_status = 4 then '待调试'
                   when village.i_status = 5 then '待验收'
                   when village.i_status = 6 then '运行中'
                   when village.i_status = 7 then '托管'
                   else '待现勘'
                   end                as iStatusName,
               village.v_village_name as vVillageName,
               village.v_village_id   as vVillageId
        from tbl_village as village
                 join tbl_project as project
                      on project.v_project_id = village.v_project_id
        where village.v_project_id = #{vProjectId, jdbcType=VARCHAR}
    </select>

    <select id="getStatistics" resultType="java.util.Map">
        select count(1) as count, 'project' as name from tbl_project
        <where>
            i_del_flag = 0
            <if test="!isAdminFlag">
                and tbl_project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select count(1) as count, 'investigate_task' as name from tbl_investigate_task
        inner join tbl_project on tbl_project.v_project_id = tbl_investigate_task.v_project_id
        <where>
            and tbl_investigate_task.i_status in (1, 2)
            <if test="!isAdminFlag">
                and tbl_project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select count(1) as count, 'distribution_task' as name from tbl_distribution_task
        <where>
            and tbl_distribution_task.i_status in (1, 2)
            <if test="!isAdminFlag">
                and tbl_project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select count(1) as count, 'installing_task' as name from tbl_installing_task
        <where>
            and tbl_installing_task.i_status in (1, 2)
            <if test="!isAdminFlag">
                and tbl_project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select count(1) as count, 'testing_task' as name from tbl_testing_task
        inner join tbl_project on tbl_project.v_project_id = tbl_testing_task.v_project_id
        <where>
            and tbl_testing_task.i_status in (1, 2)
            <if test="!isAdminFlag">
                and tbl_project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        union
        select count(1) as count, 'checking' as name from tbl_checking_task
        inner join tbl_project on tbl_project.v_project_id = tbl_checking_task.v_project_id
        <where>
            and tbl_checking_task.i_status in (1, 2)
            <if test="!isAdminFlag">
                and tbl_project.v_dept_id
                <foreach collection="permissionDeptIds" item="item" open="IN(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </select>
</mapper>