<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.shmashine.api.dao.BizRuiJinDao">

    <!-- 瑞金事件导出Excel  -->
    <resultMap type="com.shmashine.api.module.ruijin.EventDownloadModuleMap"
               id="eventDownloadModuleMap">
        <result property="elevatorName" column="v_elevator_name" jdbcType="VARCHAR"/>
        <result property="address" column="v_address" jdbcType="VARCHAR"/>
        <result property="reportTime" column="dt_report_time" jdbcType="VARCHAR"/>
        <result property="faultName" column="v_fault_name" jdbcType="VARCHAR"/>
        <result property="status" column="i_status" jdbcType="VARCHAR"/>
    </resultMap>


    <!-- 电梯列表数据查询 -->
    <select id="searchElevatorList" resultType="java.util.Map">
        select
        ele.v_elevator_id AS v_elevator_id,
        ele.v_elevator_code AS v_elevator_code,
        ele.v_elevator_name AS v_elevator_name,
        ele.v_building_id,
        ele.v_address AS v_address,
        dept.v_dept_name AS v_maintain_company_name,
        ele.i_elevator_type AS i_elevator_type,
        sysinfo.v_name_zh_cn AS i_elevator_type_name,
        ele.i_install_status AS i_install_status,
        sysinfo2.v_name_zh_cn AS i_install_status_name,
        ele.i_mode_status AS i_mode_status,
        sysinfo3.v_name_zh_cn AS i_mode_status_name,
        ele.i_on_line AS i_online_status,
        sysinfo4.v_name_zh_cn AS i_online_status_name,
        CASE
        WHEN EXISTS (
        SELECT '1' FROM tbl_third_party_ruijin_envent envent WHERE envent.register_number = ele.v_equipment_code
        AND <![CDATA[ envent.current_status < 5 ]]>
        AND envent.event_type = '2'
        AND envent.occur_time &gt; curdate()
        ) THEN 3

        WHEN EXISTS (
        SELECT '1' FROM tbl_third_party_ruijin_envent envent WHERE envent.register_number = ele.v_equipment_code
        AND <![CDATA[ envent.current_status < 5 ]]>
        AND envent.event_type = '1'
        AND envent.occur_time &gt; curdate()
        ) THEN 2
        ELSE 0 END AS i_fault_status,
        sysinfo5.v_name_zh_cn AS i_fault_status_name,
        ele.v_longitude,
        ele.v_latitude,
        ele.v_equipment_code AS register_number,
        ele.v_village_id AS villageId,
        GROUP_CONCAT(device.v_hw_version) AS v_hw_version
        from tbl_elevator ele
        <if test="!SearchElevatorModule.isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and v_user_id =
            #{SearchElevatorModule.userId}
        </if>
        LEFT JOIN tbl_device device ON ele.v_elevator_id = device.v_elevator_id and ele.v_elevator_code =
        device.v_elevator_code
        left join tbl_sys_dept dept on ele.v_maintain_company_id = dept.v_dept_id
        left join tbl_sys_systeminfo sysinfo on sysinfo.v_sysvalue5 = ele.i_elevator_type and sysinfo.v_sysid = '10002'
        left join tbl_sys_systeminfo sysinfo2 on sysinfo2.v_sysvalue5 = ele.i_install_status and sysinfo2.v_sysid =
        '10008'
        left join tbl_sys_systeminfo sysinfo3 on sysinfo3.v_sysvalue5 = ele.i_mode_status and sysinfo3.v_sysid = '10009'
        left join tbl_sys_systeminfo sysinfo4 on sysinfo4.v_sysvalue5 = ele.i_on_line and sysinfo4.v_sysid = '10007'
        left join tbl_sys_systeminfo sysinfo5 on sysinfo5.v_sysvalue5 = ele.i_fault_status and sysinfo5.v_sysid =
        '10018'
        <where>
            <if test="SearchElevatorModule.vHwVersion != null and SearchElevatorModule.vHwVersion != ''">
                <choose>
                    <when test="SearchElevatorModule.vHwVersion != '0.0'">
                        and device.v_hw_version = #{SearchElevatorModule.vHwVersion}
                    </when>
                    <otherwise>
                        and device.v_hw_version is null
                    </otherwise>
                </choose>
            </if>
            <if test="SearchElevatorModule.vElevatorCode != null and SearchElevatorModule.vElevatorCode != ''">
                and (ele.v_elevator_code like CONCAT('%',#{SearchElevatorModule.vElevatorCode},'%') or v_equipment_code
                like CONCAT('%',#{SearchElevatorModule.vElevatorCode},'%'))
            </if>
            <if test="SearchElevatorModule.iElevatorType != null">
                and ele.i_elevator_type = #{SearchElevatorModule.iElevatorType}
            </if>
            <if test="SearchElevatorModule.iInstallStatus != null">
                and ele.i_install_status = #{SearchElevatorModule.iInstallStatus}
            </if>
            <if test="SearchElevatorModule.iOnLine != null">
                and ele.i_on_line = #{SearchElevatorModule.iOnLine}
            </if>
            <if test="SearchElevatorModule.iFaultStatus != null">
                and ele.i_fault_status = #{SearchElevatorModule.iFaultStatus}
            </if>
            <if test="SearchElevatorModule.iModeStatus != null">
                and ele.i_mode_status = #{SearchElevatorModule.iModeStatus}
            </if>
            <if test="SearchElevatorModule.vProjectId != null and SearchElevatorModule.vProjectId != ''">
                and ele.v_project_id = #{SearchElevatorModule.vProjectId}
            </if>
            <if test="SearchElevatorModule.vVillageId != null and SearchElevatorModule.vVillageId != ''">
                and ele.v_village_id = #{SearchElevatorModule.vVillageId}
            </if>
            <if test="SearchElevatorModule.iProvinceId != null and SearchElevatorModule.iProvinceId != ''">
                and ele.i_province_id = #{SearchElevatorModule.iProvinceId}
            </if>
            <if test="SearchElevatorModule.iCityId != null and SearchElevatorModule.iCityId != ''">
                and ele.i_city_id = #{SearchElevatorModule.iCityId}
            </if>
            <if test="SearchElevatorModule.iAreaId != null and SearchElevatorModule.iAreaId != ''">
                and ele.i_area_id = #{SearchElevatorModule.iAreaId}
            </if>
            <if test="SearchElevatorModule.vBuildingId != null and SearchElevatorModule.vBuildingId != ''">
                and ele.v_building_id = #{SearchElevatorModule.vBuildingId}
            </if>
        </where>
        GROUP BY ele.v_elevator_id,ele.v_elevator_code
        order by i_fault_status desc, ele.v_elevator_name
    </select>

    <!-- 瑞金医院项目大屏电梯分类数量统计接口 -->
    <select id="countElevatorClassificationInfo" resultType="java.util.Map">
        SELECT
        sys.v_name_zh_cn,
        count(ele.v_elevator_code) AS `number`,
        GROUP_CONCAT(ele.v_elevator_name) as `v_codes`
        FROM tbl_elevator ele
        join tbl_sys_systeminfo sys on sys.v_syssubid = ele.i_elevator_use_type AND v_sysid = 10023
        <where>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                and ele.v_project_id = #{vProjectId}
            </if>
        </where>
        group by sys.v_name_zh_cn
    </select>


    <!-- 大屏接口电梯分类通用接口 -->
    <select id="countElevatorClassificationInfoV1" resultType="java.util.Map">
        select
        sys.v_name_zh_cn,
        count(temp.register_number) AS `number`,
        GROUP_CONCAT(temp.v_elevator_name) as `v_codes`
        from
        tbl_sys_systeminfo sys
        left join (
        SELECT
        eleRuijin.register_number,
        eleRuijin.model,
        ele.v_elevator_name
        FROM tbl_third_party_ruijin_elevator eleRuijin
        join tbl_elevator ele on eleRuijin.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            <if test="faultStatisticalQuantitySearchModule.villageId != 'null' and faultStatisticalQuantitySearchModule.villageId != ''">
                and ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
        </where>
        ) temp on sys.v_name_zh_cn = temp.model
        <where>
            sys.v_sysid = '10034' and sys.v_syssubid != '0'
        </where>
        group by sys.v_name_zh_cn
    </select>

    <!-- 故障统计 困人统计 不文明行为统计 数量统计 -->
    <select id="faultStatisticalQuantity" resultType="java.util.Map">
        SELECT
        '困人统计' AS `name`,
        count(distinct envent.event_number) AS `number`
        FROM
        tbl_third_party_ruijin_envent envent
        join tbl_elevator ele on envent.failure_code = '09' and envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            envent.current_status IN (5,6)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 6 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 29 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 11 MONTH) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT
        '故障统计' AS `name`,
        count(distinct envent.event_number) AS `number`
        FROM
        tbl_third_party_ruijin_envent envent
        join tbl_elevator ele on envent.event_type = 1 and envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            envent.current_status IN (5,6)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 6 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 29 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 11 MONTH) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT
        '不文明行为统计' AS `name`,
        count( 1 ) AS `number`
        FROM
        tbl_fault fault
        join tbl_elevator ele on ele.v_elevator_id = fault.v_elevator_id and ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            (fault.i_fault_type = 20 or fault.i_fault_type = 38 )
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
    </select>

    <!-- 故障统计 困人统计 不文明行为统计 数量统计 骋隆项目 -->
    <select id="faultStatisticalQuantityForCl" resultType="java.util.Map">
        SELECT
        '困人统计' AS `name`,
        count(distinct envent.event_number) AS `number`
        FROM
        tbl_third_party_ruijin_envent envent
        join tbl_elevator ele on envent.event_type = 2 and envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT
        '故障统计' AS `name`,
        count(distinct envent.event_number) AS `number`
        FROM
        tbl_third_party_ruijin_envent envent
        join tbl_elevator ele on envent.event_type = 1 and envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT
        '不文明行为统计' AS `name`,
        count( 1 ) AS `number`
        FROM
        tbl_fault fault
        join tbl_elevator ele on ele.v_elevator_id = fault.v_elevator_id and ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
    </select>

    <!-- 困人来源排行统计 -->
    <select id="statisticsOnTheSourceOfPoverty" resultType="java.util.Map">
        SELECT
        sys.v_sysvalue5 AS v_sysvalue5,
        sys.v_name_zh_cn,
        IFNULL(temp.number,0) AS number,
        IFNULL(temp.proportion,0) AS proportion
        FROM
        tbl_sys_systeminfo sys
        LEft JOIN
        (
        SELECT
        sys.v_sysvalue5,
        sys.v_name_zh_cn,
        count(distinct envent.event_number) AS number,
        CONCAT(ROUND((count(distinct envent.event_number) / count(1)) * 100,2),'%') AS proportion
        FROM
        tbl_sys_systeminfo sys
        left join tbl_third_party_ruijin_envent envent on sys.v_sysvalue5 = envent.event_channel
        left join tbl_elevator ele on ele.v_equipment_code = envent.register_number
        left join (select count(distinct event_number) as number from tbl_third_party_ruijin_envent) temp on 1 = 1
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            sys.v_sysid = '10029' AND sys.v_syssubid != '0' and envent.failure_code = '09'
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY sys.v_sysvalue5
        ) temp on sys.v_sysvalue5 = temp.v_sysvalue5
        WHERE
        sys.v_sysid = '10029' AND sys.v_syssubid != '0'
        ORDER BY `number` DESC, v_sysvalue5
    </select>

    <!-- 困人来源排行统计 -->
    <select id="statisticsOnTheSourceOfPovertyV1" resultType="java.util.Map">
        SELECT
        sys.v_sysvalue5 AS v_sysvalue5,
        sys.v_name_zh_cn,
        IFNULL(temp.number,0) AS number,
        IFNULL(temp.proportion,0) AS proportion
        FROM
        tbl_sys_systeminfo sys
        LEft JOIN
        (
        SELECT
        sys.v_sysvalue5,
        sys.v_name_zh_cn,
        count(distinct envent.event_number) AS number,
        CONCAT(ROUND((count(distinct envent.event_number) / count(1)) * 100,2),'%') AS proportion
        FROM
        tbl_sys_systeminfo sys
        left join tbl_third_party_ruijin_envent envent on sys.v_sysvalue5 = envent.event_channel
        left join tbl_elevator ele on ele.v_equipment_code = envent.register_number
        left join (select count(distinct event_number) as number from tbl_third_party_ruijin_envent) temp on 1 = 1
        <where>
            sys.v_sysid = '10029' AND sys.v_syssubid != '0' and envent.failure_code = '09'
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY sys.v_sysvalue5
        ) temp on sys.v_sysvalue5 = temp.v_sysvalue5
        WHERE
        sys.v_sysid = '10029' AND sys.v_syssubid != '0'
        ORDER BY `number` DESC, v_sysvalue5
    </select>

    <!-- 困人来源排行统计 骋隆 -->
    <select id="statisticsOnTheSourceOfPovertyForCl" resultType="java.util.Map">
        SELECT
        sys.v_sysvalue5 AS v_sysvalue5,
        sys.v_name_zh_cn,
        IFNULL(temp.number,0) AS number,
        IFNULL(temp.proportion,0) AS proportion
        FROM
        tbl_sys_systeminfo sys
        LEft JOIN
        (
        SELECT
        sys.v_sysvalue5,
        sys.v_name_zh_cn,
        ele.v_elevator_id as v_elevator_id,
        count(distinct envent.event_number) AS number,
        CONCAT(ROUND((count(distinct envent.event_number) / count(1)) * 100,2),'%') AS proportion
        FROM
        tbl_sys_systeminfo sys
        left join tbl_third_party_ruijin_envent envent on sys.v_sysvalue5 = envent.event_channel
        left join tbl_elevator ele on v_equipment_code = envent.register_number
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        left join (select count(distinct event_number) as number from tbl_third_party_ruijin_envent) temp on 1 = 1
        <where>
            sys.v_sysid = '10029' AND sys.v_syssubid != '0' and envent.failure_code = '09'
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY sys.v_sysvalue5, ele.v_elevator_id
        ) temp on sys.v_sysvalue5 = temp.v_sysvalue5
        WHERE
        sys.v_sysid = '10029' AND sys.v_syssubid != '0'
        ORDER BY `number` DESC, v_sysvalue5
    </select>

    <!-- 故障工单数  -->
    <select id="searchWrokOrderCount" resultType="java.lang.Integer">
        SELECT
        count(distinct envent.event_number) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        join tbl_elevator ele on ele.v_equipment_code = envent.register_number
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
    </select>

    <!-- 故障占比 -->
    <select id="statisticsFaultPoverty" resultType="java.util.Map">
        SELECT
        envent.failure_code AS i_fault_type,
        definition.fault_name AS v_fault_name,
        count(distinct envent.event_number) AS `number`
        FROM
        tbl_third_party_ruijin_envent envent
        left join tbl_elevator ele on envent.register_number = ele.v_equipment_code
        join tbl_fault_definition_0902 definition on definition.platform_type = 2 and envent.failure_code =
        definition.fault_type
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>

        <where>
            envent.event_type = 1
            AND envent.current_status IN (5,6)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 6 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 29 DAY) <= envent.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 11 MONTH) <= envent.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY
        envent.failure_code
        ORDER BY `number` DESC
    </select>

    <!-- 不文明行为统计（每种不文明行为占比） -->
    <select id="uncivilizedBehavior" resultType="java.util.Map">
        (SELECT
        definition.fault_type,
        definition.fault_name,
        ifNULL(temp.number, 0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        LEFT JOIN (
        SELECT
        fault.i_fault_type,
        count(CASE fault.v_fault_id WHEN NULL THEN 0 ELSE fault.i_fault_num END) AS number
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            <choose>
                <when test="faultTypes != null and faultTypes.size() > 0">
                    fault.i_fault_type in
                    <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </when>
                <otherwise>
                    (fault.i_fault_type = 20 or fault.i_fault_type = 37)
                </otherwise>
            </choose>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        group by fault.i_fault_type
        ) temp ON temp.i_fault_type = definition.fault_type
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                definition.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (definition.fault_type = 20 or definition.fault_type = 37)
            </otherwise>
        </choose>
        AND definition.uncivilized_behavior_flag = 1
        GROUP BY
        definition.fault_type, definition.fault_name
        ORDER BY
        temp.`number`,definition.fault_type DESC)

        UNION

        (SELECT
        'NAF' as fault_type,
        '急修工单' as fault_name,
        COUNT(1)
        FROM
        tbl_third_party_ruijin_envent `event`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `event`.register_number AND `event`.current_status IN (5,6)
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `event`.occur_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `event`.occur_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= `event`.occur_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        )

        UNION

        (SELECT
        'NAW' as fault_type,
        '维保次数' as fault_name,
        COUNT(1)
        FROM
        tbl_third_party_ruijin_work_order `workOrder`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `workOrder`.register_number
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `workOrder`.complete_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `workOrder`.complete_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= `workOrder`.complete_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        )

        UNION

        (select
        'NA' as fault_type,
        '运行次数' as fault_name,
        ifNULL(sum(ele_rd.bi_run_count), 0) AS number
        from tbl_elevator_run_count as ele_rd
        JOIN tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= ele_rd.dt_report_date]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        )

        UNION

        (select
        'NA' as fault_type,
        '客流量' as fault_name,
        ifNULL(sum(ele_rd.passenger_flow), 0) AS number
        from tbl_elevator_run_count as ele_rd
        JOIN tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= ele_rd.dt_report_date]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        )

    </select>

    <!-- 不文明行为统计（每种不文明行为占比） -->
    <select id="uncivilizedBehaviorV1" resultType="java.util.Map">
        (SELECT
        definition.fault_type,
        definition.fault_name,
        ifNULL(temp.number, 0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        LEFT JOIN (
        SELECT
        fault.i_fault_type,
        count(CASE fault.v_fault_id WHEN NULL THEN 0 ELSE fault.i_fault_num END) AS number
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            <choose>
                <when test="faultTypes != null and faultTypes.size() > 0">
                    fault.i_fault_type in
                    <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                        #{item}
                    </foreach>
                </when>
                <otherwise>
                    (fault.i_fault_type = 20 or fault.i_fault_type = 37)
                </otherwise>
            </choose>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        group by fault.i_fault_type
        ) temp ON temp.i_fault_type = definition.fault_type
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                definition.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (definition.fault_type = 20 or definition.fault_type = 37)
            </otherwise>
        </choose>
        AND definition.uncivilized_behavior_flag = 1
        GROUP BY
        definition.fault_type, definition.fault_name
        ORDER BY
        temp.`number`,definition.fault_type DESC)

        UNION

        (SELECT
        'NA' as fault_type,
        '检修次数' as fault_name,
        COALESCE(sum(ifNULL(temp.cnt, 0)), 0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        LEFT JOIN (
        SELECT
        fault.i_fault_type,
        fault.d_report_date,
        case
        when fault.i_fault_num >= 1 then 1
        else 0
        end AS cnt
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            (fault.i_fault_type = 6 or fault.i_fault_type = 29)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        group by fault.d_report_date
        ) temp ON temp.i_fault_type = definition.fault_type
        WHERE
        definition.fault_type = 6
        or
        definition.fault_type = 29)

        UNION

        (select
        'NA' as fault_type,
        '运行次数' as fault_name,
        ifNULL(sum(ele_rd.bi_run_count), 0) AS number
        from tbl_elevator_run_count as ele_rd
        JOIN tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= ele_rd.dt_report_date]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        )
    </select>

    <!-- 不文明行为统计（每种不文明行为占比）骋隆 -->
    <select id="uncivilizedBehaviorForCl" resultType="java.util.Map">
        SELECT
        definition.fault_type,
        definition.fault_name,
        ifNULL(temp.number, 0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        LEFT JOIN (
        SELECT
        fault.i_fault_type,
        count(CASE fault.v_fault_id WHEN NULL THEN 0 ELSE fault.i_fault_num END) AS number
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        group by fault.i_fault_type
        ) temp ON temp.i_fault_type = definition.fault_type
        WHERE
        definition.fault_type = 20 or definition.fault_type = 37
        AND definition.uncivilized_behavior_flag = 1
        GROUP BY
        definition.fault_type, definition.fault_name
        ORDER BY
        temp.`number`,definition.fault_type DESC
    </select>

    <!-- 每种不文明行为前三电梯占比-->
    <select id="uncivilizedBehaviorByTopThree" resultType="java.util.Map">

        <!--运行次数-->
        <if test="faultStatisticalQuantitySearchModule.faultType != null and faultStatisticalQuantitySearchModule.faultType != '' and faultStatisticalQuantitySearchModule.faultType == 0">
            SELECT
            ele.v_elevator_id,
            ele.v_elevator_code,
            ele.v_elevator_name,
            IFNULL(sum(ele_rd.bi_run_count), 0) as number
            FROM
            tbl_elevator as ele
            join tbl_elevator_run_count ele_rd on ele.v_elevator_code = ele_rd.v_elevator_code
            <where>
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= ele_rd.dt_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                        AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                        AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
                    </if>
                </if>
            </where>
            GROUP BY ele.v_elevator_id, ele.v_elevator_code
            ORDER BY number desc
            LIMIT 3
        </if>

        <!--客流量-->
        <if test="faultStatisticalQuantitySearchModule.faultType != null and faultStatisticalQuantitySearchModule.faultType != '' and faultStatisticalQuantitySearchModule.faultType == 1 ">
            SELECT
            ele.v_elevator_id,
            ele.v_elevator_code,
            ele.v_elevator_name,
            IFNULL(sum(ele_rd.passenger_flow), 0) as number
            FROM
            tbl_elevator as ele
            join tbl_elevator_run_count ele_rd on ele.v_elevator_code = ele_rd.v_elevator_code
            <where>
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= ele_rd.dt_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                        AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                        AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
                    </if>
                </if>
            </where>
            GROUP BY ele.v_elevator_id, ele.v_elevator_code
            ORDER BY number desc
            LIMIT 3
        </if>

        <!--不文明行为（关门受阻挡）-->
        <if test="faultStatisticalQuantitySearchModule.faultType != null and faultStatisticalQuantitySearchModule.faultType != '' and faultStatisticalQuantitySearchModule.faultType == 20">
            SELECT
            ele.v_elevator_id,
            ele.v_elevator_code,
            ele.v_elevator_name,
            IFNULL(sum(fault.i_fault_num),0) as number
            FROM
            tbl_elevator ele
            JOIN tbl_fault fault ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code =
            fault.v_elevator_code
            <!--<if test="!faultStatisticalQuantitySearchModule.isAdminFlag">-->
            <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
            <!--#{faultStatisticalQuantitySearchModule.userId}-->
            <!--</if>-->
            <where>
                <if test="faultStatisticalQuantitySearchModule.faultType != null and faultStatisticalQuantitySearchModule.faultType != ''">
                    AND fault.i_fault_type = #{faultStatisticalQuantitySearchModule.faultType}
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                    </if>
                </if>
                <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                    AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                </if>
                <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                    AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
                </if>
            </where>
            GROUP BY ele.v_elevator_id,ele.v_elevator_code
            ORDER BY number desc
            LIMIT 3
        </if>

        <!--运维工单次数-->
        <if test="faultStatisticalQuantitySearchModule.faultType == null or faultStatisticalQuantitySearchModule.faultType == ''">
            SELECT
            ma.v_elevator_name,
            ma.v_elevator_id,
            SUM(ma.c) AS num
            FROM
            (SELECT
            ele.v_elevator_name,
            ele.v_elevator_id,
            'event' AS name,
            COUNT(1) AS c
            FROM
            tbl_third_party_ruijin_envent `event`
            JOIN tbl_elevator ele ON ele.v_equipment_code = `event`.register_number AND `event`.current_status = 6
            <where>
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `event`.occur_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `event`.occur_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= `event`.occur_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                        AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                        AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
                    </if>
                </if>
            </where>
            GROUP BY ele.v_elevator_id

            UNION

            SELECT
            ele.v_elevator_name,
            ele.v_elevator_id,
            'workOrder' AS name,
            COUNT(1) AS c
            FROM
            tbl_third_party_ruijin_work_order `workOrder`
            JOIN tbl_elevator ele ON ele.v_equipment_code = `workOrder`.register_number AND `workOrder`.order_status =
            40
            <where>
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `workOrder`.complete_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `workOrder`.complete_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= `workOrder`.complete_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                        AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                        AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
                    </if>
                </if>
            </where>
            GROUP BY ele.v_elevator_id) AS ma
            GROUP BY ma.v_elevator_id
            ORDER BY num DESC
            LIMIT 3
        </if>
    </select>

    <!-- 每种不文明行为前三电梯占比-->
    <select id="uncivilizedBehaviorByTopThreeV1" resultType="java.util.Map">
        <if test="faultStatisticalQuantitySearchModule.faultType != null and faultStatisticalQuantitySearchModule.faultType != '' and faultStatisticalQuantitySearchModule.faultType != '0'">
            SELECT
            ele.v_elevator_id,
            ele.v_elevator_code,
            ele.v_elevator_name,
            IFNULL(sum(fault.i_fault_num),0) as number
            FROM
            tbl_elevator ele
            JOIN tbl_fault fault ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code =
            fault.v_elevator_code
            <!--<if test="!faultStatisticalQuantitySearchModule.isAdminFlag">-->
            <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
            <!--#{faultStatisticalQuantitySearchModule.userId}-->
            <!--</if>-->
            <where>
                <if test="faultStatisticalQuantitySearchModule.faultType != null and faultStatisticalQuantitySearchModule.faultType != ''">
                    AND fault.i_fault_type = #{faultStatisticalQuantitySearchModule.faultType}
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                    </if>
                </if>
                <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                    AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                </if>
            </where>
            GROUP BY ele.v_elevator_id,ele.v_elevator_code
            ORDER BY number desc
            LIMIT 3
        </if>

        <if test="faultStatisticalQuantitySearchModule.faultType == null or faultStatisticalQuantitySearchModule.faultType == ''">
            SELECT
            ele.v_elevator_id,
            ele.v_elevator_code,
            ele.v_elevator_name,
            COALESCE(sum(ifNULL(temp.cnt, 0)), 0) AS number
            FROM
            `tbl_elevator` ele
            INNER JOIN (
            SELECT
            fault.i_fault_type,
            fault.d_report_date,
            fault.v_elevator_id,
            case
            when fault.i_fault_num >= 1 then 1
            else 0
            end AS cnt
            FROM
            tbl_fault fault
            JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code =
            fault.v_elevator_code
            <where>
                (fault.i_fault_type = 6 or fault.i_fault_type = 29)
                <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                        AND <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.d_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                        AND <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.d_report_date]]>
                    </if>
                    <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                        AND <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.d_report_date]]>
                    </if>
                </if>
                <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                    AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                </if>
            </where>
            group by fault.d_report_date, fault.v_elevator_id
            ) temp ON temp.v_elevator_id = ele.v_elevator_id
            GROUP BY ele.v_elevator_id, ele.v_elevator_name
            ORDER BY number desc
            LIMIT 3
        </if>
    </select>

    <select id="uncivilizedBehaviorByTopThreeV1RunCount" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        ele.v_elevator_code,
        ele.v_elevator_name,
        IFNULL(sum(ele_rd.bi_run_count), 0) as number
        FROM
        tbl_elevator as ele
        join tbl_elevator_run_count ele_rd on ele.v_elevator_code = ele_rd.v_elevator_code
        <where>
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= ele_rd.dt_report_date]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                    AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
                </if>
            </if>
        </where>
        GROUP BY ele.v_elevator_id, ele.v_elevator_code
        ORDER BY number desc
        LIMIT 3
    </select>

    <!-- 智能监管 通用-->
    <select id="intelligentSupervisionV1" resultType="java.util.Map">
        SELECT
        '维保单位' AS `lable`,
        maintenance_company_name AS number,
        '' AS `name`
        FROM
        `tbl_third_party_ruijin_maintenance`
        where
        register_number = '31103101042006030320'

        union

        SELECT
        '维保逾期电梯' AS `label`,
        COUNT(`order`.work_order_number) AS `number`,
        GROUP_CONCAT( DISTINCT ele.v_elevator_name ORDER BY ele.v_elevator_name ) AS `name`
        FROM
        tbl_third_party_ruijin_work_order `order`
        inner join
        tbl_elevator as ele on order.register_number = ele.v_equipment_code
        <where>
            <![CDATA[
             Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
             ]]>
            <if test="module.timeFlag == '00'">
                <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `order`.should_complete_date]]>
            </if>

            <if test="module.timeFlag == '11'">
                <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.should_complete_date ]]>
            </if>

            <if test="module.timeFlag == '22'">
                <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= `order`.should_complete_date ]]>
            </if>
            <if test="module.villageId != null and module.villageId != ''">
                AND ele.v_village_id = #{module.villageId}
            </if>
        </where>

        UNION

        SELECT
        '年检30天内到期电梯' as `label`,
        count( DISTINCT ele.v_elevator_name ) AS number,
        GROUP_CONCAT( DISTINCT ele.v_elevator_name ORDER BY ele.v_elevator_name ) AS `name`
        from
        `tbl_elevator` as ele
        <!--<if test="!module.isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{module.userId}-->
        <!--</if>-->
        where (ele.d_next_inspect_date between CURDATE() and DATE_ADD(CURDATE(), INTERVAL 30 DAY))
        <if test="module.villageId != null and module.villageId != ''">
            AND ele.v_village_id = #{module.villageId}
        </if>

        UNION

        SELECT
        '年检缺失电梯' as `label`,
        count( DISTINCT ele.v_elevator_code ) AS `number`,
        GROUP_CONCAT( DISTINCT ele.v_elevator_name ORDER BY ele.v_elevator_name ) AS `name`
        from
        `tbl_elevator` as ele
        <!--<if test="!module.isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{module.userId}-->
        <!--</if>-->
        where (ele.d_next_inspect_date is null or
        <![CDATA[DATE_ADD(ele.d_last_inspect_date, INTERVAL 1 year ) < ele.d_next_inspect_date ]]>)
        <if test="module.villageId != null and module.villageId != ''">
            AND ele.v_village_id = #{module.villageId}
        </if>

        <!--<if test="module.maintenanceCompanyCode != null and module.maintenanceCompanyCode != ''">-->
        <!--where maintenance.maintenance_company_code in-->
        <!--<foreach collection="module.maintenanceCompanyCode.split(',')" item="item" index="index" open="(" close=")" separator=",">-->
        <!--#{item}-->
        <!--</foreach>-->
        <!--</if>-->
    </select>

    <!-- 智能监管 -->
    <select id="intelligentSupervision" resultType="java.util.Map">
        SELECT '维保单位' AS `lable`, maintenance_company_name AS number, '' AS `name`
        FROM `tbl_third_party_ruijin_maintenance`
        WHERE register_number = '31103101042006030320'

        UNION

        SELECT '维保工人数' AS `lable`, count( DISTINCT maintenance.first_maintainer_id_number ) + count( DISTINCT
        maintenance.second_maintainer_id_number ) AS number, '' AS `name`
        FROM `tbl_third_party_ruijin_maintenance` maintenance

        UNION

        SELECT '当日需维保电梯' AS `lable`, count( 1 ) AS number, GROUP_CONCAT( DISTINCT ele.v_elevator_name ORDER BY
        ele.v_elevator_name ) AS `name`
        FROM tbl_third_party_ruijin_work_order wo
        JOIN tbl_elevator ele ON ele.v_equipment_code = wo.register_number
        JOIN (SELECT t_wo.register_number, max( t_wo.work_order_number ) AS work_order_number
        FROM tbl_third_party_ruijin_work_order t_wo
        GROUP BY t_wo.register_number
        ) temp ON wo.work_order_number = temp.work_order_number
        <where>
            ( DATE(wo.next_maintenance_date) = CURDATE( ) OR DATE(wo.should_complete_date) = CURDATE( ) )
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            <if test="module.vProjectId != null and module.vProjectId != 'null' and module.vProjectId != 'undefined' and module.vProjectId != ''">
                and ele.v_project_id = #{module.vProjectId}
            </if>
        </where>

        UNION

        SELECT '缺失维保电梯' AS `lable`, count( maintenance.register_number ) AS number, GROUP_CONCAT( DISTINCT
        maintenance.internal_number ORDER BY maintenance.internal_number ) AS `name`
        FROM `tbl_third_party_ruijin_maintenance` maintenance
        JOIN ( SELECT max( next_maintenance_date ) AS next_maintenance_date, register_number
        FROM tbl_third_party_ruijin_work_order
        GROUP BY register_number ) checkTbl ON checkTbl.register_number = maintenance.register_number
        JOIN tbl_elevator ele ON maintenance.register_number = ele.v_equipment_code
        <where>
            DATE_SUB( CURDATE( ), INTERVAL 0 DAY ) > checkTbl.next_maintenance_date
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            <if test="module.vProjectId != null and module.vProjectId != 'null' and module.vProjectId != 'undefined' and module.vProjectId != ''">
                and ele.v_project_id = #{module.vProjectId}
            </if>
        </where>

        UNION

        SELECT '当前需处理故障' AS `lable`, count( temp.v_elevator_name ) AS number, GROUP_CONCAT( temp.v_elevator_name
        ) AS `name`
        FROM (SELECT DISTINCT ele.v_elevator_name
        FROM tbl_elevator ele
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        WHERE envent.event_type = 1 and envent.current_status &lt; 5 and envent.occur_time &gt; curdate()
        <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
            and ele.v_village_id = #{module.villageId}
        </if>
        <if test="module.vProjectId != null and module.vProjectId != 'null' and module.vProjectId != 'undefined' and module.vProjectId != ''">
            and ele.v_project_id = #{module.vProjectId}
        </if>
        ) temp

        UNION

        /*检验2周内到期改成检验前30天开始提醒，直到检验为止*/
        SELECT '检验30天内到期电梯' AS `lable`, count( DISTINCT ele.v_elevator_code ) AS number, GROUP_CONCAT( DISTINCT
        ele.v_elevator_name ORDER BY ele.v_elevator_code ) AS `name`
        FROM tbl_elevator ele
        <where>
            <![CDATA[ DATE_SUB( CURDATE(), INTERVAL 0 DAY ) <= ele.d_next_inspect_date]]>
            AND <![CDATA[ DATE_SUB( CURDATE(), INTERVAL -30 DAY) >= ele.d_next_inspect_date]]>
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            <if test="module.vProjectId != null and module.vProjectId != 'null' and module.vProjectId != 'undefined' and module.vProjectId != ''">
                and ele.v_project_id = #{module.vProjectId}
            </if>
        </where>

        UNION

        SELECT '检验缺失电梯' AS `lable`, count( DISTINCT temp.v_elevator_name ) AS number, GROUP_CONCAT( DISTINCT
        temp.v_elevator_name ORDER BY temp.v_elevator_name ) AS `name`
        FROM (SELECT max( checkTbl.inspect_date ) AS inspect_date, max( checkTbl.next_inspect_date ) AS
        next_inspect_date, ele.v_elevator_name AS v_elevator_name
        FROM tbl_thrid_party_ruijin_check checkTbl
        JOIN tbl_elevator ele ON checkTbl.register_number = ele.v_equipment_code
        <where>
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            <if test="module.vProjectId != null and module.vProjectId != 'null' and module.vProjectId != 'undefined' and module.vProjectId != ''">
                and ele.v_project_id = #{module.vProjectId}
            </if>
        </where>
        GROUP BY ele.v_equipment_code
        ) temp
        WHERE DATE_FORMAT(CURDATE(), '%Y-%m-01') > temp.next_inspect_date

        UNION

        SELECT '当月困人电梯' AS `lable`, count( temp.v_elevator_name ) AS number, GROUP_CONCAT( temp.v_elevator_name )
        AS `name`
        FROM (SELECT DISTINCT ele.v_elevator_name
        FROM tbl_elevator ele
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        WHERE envent.event_type = 2 and envent.occur_time >= DATE_FORMAT(CURDATE(), '%Y-%m-01 00:00:00')
        <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
            and ele.v_village_id = #{module.villageId}
        </if>
        <if test="module.vProjectId != null and module.vProjectId != 'null' and module.vProjectId != 'undefined' and module.vProjectId != ''">
            and ele.v_project_id = #{module.vProjectId}
        </if>
        ) temp

    </select>

    <!-- 智能监管 骋隆-->
    <select id="intelligentSupervisionForCl" resultType="java.util.Map">
        SELECT
        '维保单位' AS `lable`,
        maintenance_company_name AS number,
        '' AS `name`
        FROM
        `tbl_third_party_ruijin_maintenance`
        WHERE
        register_number = '31103101122020060083'

        UNION

        SELECT
        '维保工人数' AS `lable`,
        count( DISTINCT maintenance.first_maintainer_id_number ) + count( DISTINCT
        maintenance.second_maintainer_id_number ) AS number,
        '' AS `name`
        FROM
        `tbl_third_party_ruijin_maintenance` maintenance
        where register_number = '31103101122020060083'

        UNION

        SELECT
        '当日需维保电梯' AS `lable`,
        count( 1 ) AS number,
        GROUP_CONCAT( DISTINCT ele.v_elevator_name ORDER BY ele.v_elevator_name ) AS `name`
        FROM
        tbl_third_party_ruijin_work_order wo
        JOIN tbl_elevator ele ON ele.v_equipment_code = wo.register_number
        JOIN (
        SELECT
        t_wo.register_number as register_number,
        max( t_wo.work_order_number ) AS work_order_number
        FROM tbl_third_party_ruijin_work_order t_wo
        GROUP BY t_wo.register_number
        ) temp ON wo.work_order_number = temp.work_order_number
        <where>
            ( DATE(wo.next_maintenance_date) = CURDATE( ) OR DATE(wo.should_complete_date) = CURDATE( ) )
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            and temp.register_number = "31103101122020060083"
        </where>

        <!--        SELECT-->
        <!--        '当日需维保电梯' AS `lable`,-->
        <!--        count( DISTINCT maintenance.register_number ) AS number,-->
        <!--        GROUP_CONCAT( DISTINCT maintenance.internal_number ORDER BY maintenance.internal_number ) AS `name`-->
        <!--        FROM-->
        <!--        tbl_third_party_ruijin_maintenance maintenance-->
        <!--        JOIN-->
        <!--        `tbl_third_party_ruijin_work_order` wo ON wo.register_number = maintenance.register_number-->
        <!--        JOIN tbl_elevator ele ON maintenance.register_number = ele.v_equipment_code-->
        <!--        <where>-->
        <!--            ( DATE(wo.next_maintenance_date) = CURDATE( ) OR DATE(wo.should_complete_date) = CURDATE( ) )-->
        <!--            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">-->
        <!--                and ele.v_village_id = #{module.villageId}-->
        <!--            </if>-->
        <!--        </where>-->

        UNION

        SELECT
        '缺失维保电梯' AS `lable`,
        count( maintenance.register_number ) AS number,
        GROUP_CONCAT( DISTINCT maintenance.internal_number ORDER BY maintenance.internal_number ) AS `name`
        FROM
        `tbl_third_party_ruijin_maintenance` maintenance
        JOIN ( SELECT max( next_maintenance_date ) AS next_maintenance_date, register_number FROM
        tbl_third_party_ruijin_work_order GROUP BY register_number ) checkTbl ON checkTbl.register_number =
        maintenance.register_number
        JOIN tbl_elevator ele ON maintenance.register_number = ele.v_equipment_code
        <where>
            DATE_SUB( CURDATE( ), INTERVAL 0 DAY ) > checkTbl.next_maintenance_date
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            and maintenance.register_number = "31103101122020060083"
        </where>

        UNION
        SELECT
        '当前需处理故障' AS `lable`,
        count( temp.v_elevator_name ) AS number,
        GROUP_CONCAT( temp.v_elevator_name ) AS `name`
        FROM
        (
        SELECT DISTINCT
        ele.v_elevator_name
        FROM
        tbl_elevator ele
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        WHERE
        <![CDATA[ envent.event_type = 1 and envent.current_status < 5]]>
        <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
            and ele.v_village_id = #{module.villageId}
        </if>
        and envent.register_number = "31103101122020060083"
        ) temp

        UNION

        /*检验2周内到期改成检验前30天开始提醒，直到检验为止*/
        SELECT
        '检验30天内到期电梯' AS `lable`,
        count( DISTINCT maintenance.register_number ) AS number,
        GROUP_CONCAT( DISTINCT ele.v_elevator_name ORDER BY ele.v_elevator_name ) AS `name`
        FROM
        tbl_third_party_ruijin_maintenance maintenance
        JOIN
        tbl_thrid_party_ruijin_check checkTbl ON checkTbl.register_number = maintenance.register_number
        JOIN tbl_elevator ele ON maintenance.register_number = ele.v_equipment_code
        <where>
            <![CDATA[ DATE_SUB( CURDATE(), INTERVAL 0 DAY ) <= `checkTbl`.next_inspect_date]]>
            AND <![CDATA[ DATE_SUB( CURDATE(), INTERVAL -30 DAY) >= `checkTbl`.next_inspect_date]]>
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            and maintenance.register_number = "31103101122020060083"
        </where>

        UNION

        SELECT
        '检验缺失电梯' AS `lable`,
        count( DISTINCT temp.internal_number ) AS number,
        GROUP_CONCAT( DISTINCT temp.internal_number ORDER BY temp.internal_number ) AS `name`
        FROM
        (
        SELECT
        max( checkTbl.inspect_date ) AS inspect_date,
        max( checkTbl.next_inspect_date ) AS next_inspect_date,
        maintenance.internal_number
        FROM
        tbl_third_party_ruijin_maintenance maintenance
        JOIN tbl_thrid_party_ruijin_check checkTbl ON checkTbl.register_number = maintenance.register_number
        JOIN tbl_elevator ele ON maintenance.register_number = ele.v_equipment_code
        <where>
            <if test="module.villageId != null and module.villageId != 'null' and module.villageId != 'undefined' and module.villageId != ''">
                and ele.v_village_id = #{module.villageId}
            </if>
            and maintenance.register_number = "31103101122020060083"
        </where>
        GROUP BY
        internal_number
        ) temp
        WHERE
        DATE_SUB( CURDATE( ), INTERVAL 0 DAY ) > temp.next_inspect_date
    </select>

    <!-- 基本电梯信息查询 大屏 -->
    <select id="getElevatorInfo" resultType="java.util.Map">
        SELECT ele.v_elevator_code,
               ele.v_elevator_name,
               IFNULL(ele.v_address, '--')                        AS v_address,
               IFNULL(envent.occur_time, '无故障')                AS real_time_fault,
               IFNULL(envent.occur_time, '暂无')                  AS start_fault_time,
               IFNULL(envent.event_desc, '无故障')                AS fault_name,
               IFNULL(ele.v_equipment_code, '--')                 AS v_equipment_code,
               IFNULL(brand.v_elevator_brand_name, '--')          AS v_elevator_brand_name,
               IFNULL(sys.v_name_zh_cn, '--')                     AS elevator_type_name,
               IFNULL(sys2.v_name_zh_cn, '--')                    AS fault_status,
               IFNULL(ele.d_last_maintain_date, '--')             AS last_maintain_date,
               IFNULL(ele.d_next_inspect_date, '--')              AS next_inspect_date,
               ele.dt_install_time                                AS dt_install_time,
               IFNULL(ele.bi_run_count, '--')                     AS bi_run_count,
               IFNULL(ele.bi_door_count, '--')                    AS bi_door_count,
               IFNULL(ele.bi_bend_count, '--')                    AS bi_bend_count,
               IFNULL(ele.bi_run_distance_count, '--')            AS bi_run_distance_count,
               IFNULL(maintenance.first_maintainer_name, '暂无')  AS first_maintainer_name,
               IFNULL(maintenance.second_maintainer_name, '暂无') AS second_maintainer_name,
               IFNULL(maintenance.safety_administrator, '暂无')   AS safety_administrator
        FROM tbl_elevator ele
                 JOIN tbl_third_party_ruijin_elevator ruijinEle ON ruijinEle.register_number = ele.v_equipment_code
                 left JOIN tbl_third_party_ruijin_maintenance maintenance
                           ON maintenance.register_number = ele.v_equipment_code
                 left JOIN tbl_third_party_ruijin_envent envent
                           on envent.register_number = ele.v_equipment_code and <![CDATA[ envent.current_status < 5 ]]>
        left JOIN tbl_elevator_brand brand on brand.v_elevator_brand_id = ele.v_elevator_brand_id
                 left JOIN tbl_sys_systeminfo sys on sys.v_sysid = '10002' and sys.v_syssubid != '0' and ele.i_elevator_type = sys.v_sysvalue5
        left JOIN tbl_sys_systeminfo sys2
        on sys2.v_sysid = '10018' and sys2.v_syssubid != '0' and ele.i_fault_status = sys2.v_sysvalue5
        where
            ele.v_equipment_code = #{register_number}
        group by ele.v_elevator_code, ele.v_equipment_code
    </select>

    <!-- 电梯历史信息 困人记录 故障记录 不文明行为 -->
    <select id="getElevatorHlsInfoSleepy" resultType="java.util.Map">
        SELECT
        envent.event_id,
        ele.v_elevator_code,
        ele.v_address,
        SUBSTRING( envent.reporter, 6 ) AS v_fault_id,
        envent.occur_time AS dt_report_time,
        temp.dt_end_time,
        TIMEDIFF( temp.dt_end_time, envent.occur_time ) AS duration_time
        FROM
        tbl_elevator ele
        JOIN tbl_third_party_ruijin_envent envent ON envent.register_number = ele.v_equipment_code
        LEFT JOIN (
        SELECT event_id, max( status_time ) AS dt_end_time FROM tbl_third_party_ruijin_envent_detail detail
        WHERE detail.STATUS = 5 GROUP BY event_id
        ) temp ON temp.event_id = envent.event_id
        <where>
            envent.event_type = '2'
            <if test="register_number != null and register_number != ''">
                and envent.register_number = #{register_number}
            </if>
        </where>
        order by envent.occur_time desc
        limit 3
    </select>

    <!-- 电梯历史信息 困人记录 故障记录 不文明行为  -->
    <select id="getElevatorHlsInfoFault" resultType="java.util.Map">
        SELECT
        ele.v_elevator_code,
        ele.v_address,
        SUBSTRING( envent.reporter, 6 ) AS v_fault_id,
        envent.occur_time AS dt_report_time,
        definition.fault_name AS v_fault_name,
        temp.dt_end_time,
        CAST(TIMEDIFF(temp.dt_end_time, envent.occur_time ) AS CHAR) AS duration_time
        FROM
        tbl_elevator ele
        JOIN tbl_third_party_ruijin_envent envent ON envent.register_number = ele.v_equipment_code
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code and
        definition.platform_type = 2
        LEFT JOIN (
        SELECT event_id, max( status_time ) AS dt_end_time
        FROM tbl_third_party_ruijin_envent_detail detail
        WHERE detail.STATUS > 4 GROUP BY event_id
        ) temp ON temp.event_id = envent.event_id
        <where>
            envent.event_type = '1'
            <if test="register_number != null and register_number != ''">
                and envent.register_number = #{register_number}
            </if>
        </where>
        order by envent.occur_time desc
        limit 3
    </select>

    <!-- 电梯历史信息 困人记录 故障记录 不文明行为  -->
    <select id="getElevatorHlsInfoUncivilizedBehavior" resultType="java.util.Map">
        SELECT
        ele.v_elevator_code,
        ele.v_address,
        fault.v_fault_id,
        fault.d_report_date,
        fault.dt_report_time,
        fault.dt_end_time,
        v_fault_name,
        i_fault_num
        FROM
        tbl_elevator ele
        JOIN tbl_third_party_ruijin_elevator ruijinEle ON ruijinEle.register_number = ele.v_equipment_code
        LEFT JOIN tbl_fault fault ON fault.v_elevator_id = ele.v_elevator_id
        AND fault.v_elevator_code = ele.v_elevator_code
        AND fault.i_status = '1'
        <where>
            (fault.i_fault_type = 20 or fault.i_fault_type = 38 or fault.i_fault_type = 39)
            <if test="register_number != null and register_number != ''">
                and ele.v_equipment_code = #{register_number}
            </if>
        </where>
        order by fault.dt_report_time desc
        limit 2
    </select>

    <!-- 电梯历史信息 困人记录 故障记录 不文明行为 骋隆  -->
    <select id="getElevatorHlsInfoUncivilizedBehaviorForCl" resultType="java.util.Map">
        SELECT
        ele.v_elevator_code,
        ele.v_address,
        fault.v_fault_id,
        fault.d_report_date,
        fault.dt_report_time,
        fault.dt_end_time,
        v_fault_name,
        i_fault_num
        FROM
        tbl_elevator ele
        JOIN tbl_third_party_ruijin_elevator ruijinEle ON ruijinEle.register_number = ele.v_equipment_code
        LEFT JOIN tbl_fault fault ON fault.v_elevator_id = ele.v_elevator_id
        AND fault.v_elevator_code = ele.v_elevator_code
        AND fault.i_status = '1'
        <where>
            (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            <if test="register_number != null and register_number != ''">
                and ele.v_equipment_code = #{register_number}
            </if>
        </where>
        order by fault.dt_report_time desc
        limit 2
    </select>

    <!-- 根据工单查看工单详情信息 -->
    <select id="getEnventDetailById" resultType="java.util.Map">
        SELECT status_time,
               status,
               handler,
               handler_tel,
               rescue_company_name,
               CASE STATUS
                   WHEN 1 THEN
                       '渠道上报'
                   WHEN 2 THEN
                       '新建工单'
                   WHEN 3 THEN
                       '已接单'
                   WHEN 4 THEN
                       '已签到'
                   WHEN 5 THEN
                       '已完成'
                   WHEN 6 THEN
                       '已确认'
                   end
                   AS comment
        FROM tbl_third_party_ruijin_envent_detail
        where event_id = #{ event_id }
        ORDER BY status_time desc
    </select>

    <!--    &lt;!&ndash;正常维保&ndash;&gt;-->
    <!--    <select id="numberOfNormalMaintenanceWorkOrders" resultType="int">-->
    <!--        SELECT count( 1 )-->
    <!--        FROM-->
    <!--        `tbl_third_party_ruijin_work_order` `order`-->
    <!--        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">-->
    <!--            join tbl_elevator ele on ele.v_equipment_code = `order`.register_number-->
    <!--            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
    <!--            #{faultStatisticalQuantitySearchModule.userId}-->
    <!--        </if>-->
    <!--        <where>-->
    <!--            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">-->
    <!--                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">-->
    <!--                    <![CDATA[-->
    <!--                         Date ( `order`.complete_time )<= Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))-->
    <!--                         AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `order`.should_complete_date-->
    <!--                    ]]>-->
    <!--                </if>-->
    <!--                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">-->
    <!--                    <![CDATA[-->
    <!--                         Date ( `order`.complete_time )<= Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))-->
    <!--                         AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.should_complete_date-->
    <!--                    ]]>-->
    <!--                </if>-->
    <!--                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">-->
    <!--                    <![CDATA[-->
    <!--                         Date ( `order`.complete_time )<= Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))-->
    <!--                         AND DATE_SUB(CURDATE(), INTERVAL 356 DAY) <= `order`.should_complete_date-->
    <!--                    ]]>-->
    <!--                </if>-->
    <!--            </if>-->
    <!--            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">-->
    <!--                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}-->
    <!--            </if>-->
    <!--        </where>-->
    <!--    </select>-->

    <!--超期维保-->
    <select id="numberOfOverdueMaintenanceWorkOrders" resultType="int">
        SELECT count( 1 )
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            join tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[
                         Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
                         AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `order`.should_complete_date
                    ]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[
                         Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
                         AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.should_complete_date
                    ]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[
                         Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
                         AND DATE_SUB(CURDATE(), INTERVAL 356 DAY) <= `order`.should_complete_date
                    ]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
        </where>
    </select>

    <!--分组查询维保记录-->
    <select id="queryMaintenanceWorkOrders" resultType="java.util.Map">
        SELECT
        ifnull(`order`.overdue, 0) AS overdue,
        ifnull(COUNT(`order`.register_number), 0) AS num
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `order`.register_number
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[
                         DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= DATE (`order`.should_complete_date)
                    ]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[
                         DATE_SUB(CURDATE(), INTERVAL 1 MONTH) <= DATE (`order`.should_complete_date)
                    ]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[
                         DATE_SUB(CURDATE(), INTERVAL 1 YEAR) <= DATE (`order`.should_complete_date)
                    ]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.elevatorCode != null and faultStatisticalQuantitySearchModule.elevatorCode != ''">
                AND ele.v_elevator_code = #{faultStatisticalQuantitySearchModule.elevatorCode}
            </if>
        </where>
        GROUP BY `order`.overdue
    </select>


    <!--分组查询维保记录-->
    <select id="queryMaintenanceWorkOrdersList" resultType="java.util.Map">
        SELECT
        order.id,
        order.register_number,
        ele.v_elevator_code,
        ele.v_elevator_name,
        ele.v_address,
        ele.v_village_id AS villageId,
        order.should_complete_date as should_complete_date,
        order.complete_time as complete_time,
        order.next_maintenance_date as next_maintenance_time,
        DATE( `order`.complete_time ) AS complete_data,
        DATE( `order`.next_maintenance_date ) AS next_maintenance_date,
        order.work_order_number as workOrderNumber,
        order.deal_employee_name as deal_employee_name,
        order.deal_employee_tel as deal_employee_tel,
        order.sign_time as sign_time,
        order.order_type_number as order_type_number,
        order.overdue as overdue,
        order.order_status as i_status
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `order`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and DATE_FORMAT(order.complete_time,'%Y-%m-%d') >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and DATE_FORMAT(order.complete_time,'%Y-%m-%d') <=  #{dtEndTime} ]]>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and order.order_type_number = #{iFaultType}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="iStatus != null and iStatus != '' ">
                AND order.order_status = #{iStatus}
            </if>
            <if test="overdue != null ">
                AND order.overdue = #{overdue}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and (
                ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
                or ele.v_elevator_name like CONCAT('%',#{vElevatorCode},'%')
                )
            </if>
        </where>
        ORDER BY complete_time desc, register_number
    </select>

    <!--分组查询维保记录-->
    <select id="queryMaintenanceWorkOrdersListDownload"
            resultType="com.shmashine.api.module.fault.output.QueryMaintenanceExportModule">
        SELECT
        ele.v_elevator_code as vElevatorCode,
        ele.v_elevator_name as vElevatorName,
        ele.v_address as vAddress,
        village.v_village_name as vVillageName,
        project.v_project_name as vProjectName,
        order.should_complete_date as shouldCompleteDate,
        DATE( `order`.complete_time ) AS completeTime,
        order.deal_employee_name as employeeName,
        case order.order_status
        when '10' then '新建'
        when '20' then '已签到'
        when '30' then '已完成'
        when '40' then '已确认'
        end as vStatusName,
        (case
        <![CDATA[ when DATE( `order`.should_complete_date ) < `order`.complete_time then '未逾期']]>
        else '已逾期'
        end) as vMaintenanceStatus
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `order`.register_number
        left join tbl_village village on village.v_village_id = ele.v_village_id
        left join tbl_project project on project.v_project_id = ele.v_project_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and DATE_FORMAT(order.complete_time,'%Y-%m-%d') >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and DATE_FORMAT(order.complete_time,'%Y-%m-%d') <=  #{dtEndTime} ]]>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and order.order_type_number = #{iFaultType}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="iStatus != null and iStatus != ''">
                AND order.order_status = #{iStatus}
            </if>
            <if test="overdue != null and overdue != ''">
                AND order.overdue = #{overdue}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and (
                ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
                or ele.v_elevator_name like CONCAT('%',#{vElevatorCode},'%')
                )
            </if>
        </where>
        ORDER BY complete_time desc, register_number
        limit 0, 500
    </select>

    <!-- 维保工单次数统计 -->
    <select id="numberOfMaintenanceWorkOrders" resultType="java.util.Map">
        SELECT
        'total_work_order_number' AS `Key`,
        count( 1 ) AS number
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            join tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE (DATE_SUB(CURDATE(), INTERVAL 7 DAY)) <= DATE (`order`.should_complete_date)]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE (DATE_SUB(CURDATE(), INTERVAL 30 DAY)) <= DATE (`order`.should_complete_date)]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE (DATE_SUB(CURDATE(), INTERVAL 365 DAY)) <= DATE (`order`.should_complete_date)]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.elevatorCode != null and faultStatisticalQuantitySearchModule.elevatorCode != ''">
                AND ele.v_elevator_code = #{faultStatisticalQuantitySearchModule.elevatorCode}
            </if>
        </where>
        UNION

        SELECT
        'finish_work_order_number' AS `Key`,
        count( 1 ) AS number
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            join tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            complete_time IS NOT NULL
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE (DATE_SUB(CURDATE(), INTERVAL 7 DAY)) <= DATE (`order`.should_complete_date)]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE (DATE_SUB(CURDATE(), INTERVAL 30 DAY)) <= DATE (`order`.should_complete_date)]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE (DATE_SUB(CURDATE(), INTERVAL 365 DAY)) <= DATE (`order`.should_complete_date)]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.elevatorCode != null and faultStatisticalQuantitySearchModule.elevatorCode != ''">
                AND ele.v_elevator_code = #{faultStatisticalQuantitySearchModule.elevatorCode}
            </if>
        </where>
    </select>

    <!-- 困人救援统计 -->
    <select id="statisticsOfTrappedPeopleRescue" resultType="java.util.Map">
        SELECT
        '困人历史工单数' AS `key`,
        IFNULL(count(1),0) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            envent.event_type = 2
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
        </where>

        UNION

        SELECT
        '救援到场统计数' AS `key`,
        IFNULL(count(1),0) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            envent.event_type = 2 AND envent.rescue_company_name is not null
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
        </where>

        UNION

        SELECT
        '维保到场解救人数' AS `key`,
        sum(envent.rescue_num) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            envent.event_type = 2
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
        </where>

        UNION

        SELECT
        '救援解困平均时间' AS `key`,
        avg( TIMESTAMPDIFF( SECOND, temp.start_time, temp.end_time ) ) AS number
        FROM
        (
        SELECT
        detail.event_id,
        max( detail.status_time ) AS end_time,
        min( detail.status_time ) AS start_time
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        JOIN tbl_third_party_ruijin_envent_detail detail ON detail.event_id = envent.event_id
        <where>
            envent.event_type = 2
            AND envent.rescue_company_name IS NOT NULL
            AND (detail.`status` = 1 OR detail.`status` = 5)
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
        </where>
        GROUP BY event_id
        ) temp

        UNION

        SELECT
        '救援到场平均时间' AS `key`,
        avg( TIMESTAMPDIFF( SECOND, temp.start_time, temp.end_time ) ) AS number
        FROM
        (
        SELECT
        detail.event_id,
        max( detail.status_time ) AS end_time,
        min( detail.status_time ) AS start_time
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        JOIN tbl_third_party_ruijin_envent_detail detail ON detail.event_id = envent.event_id
        <where>
            envent.event_type = 2
            AND envent.rescue_company_name IS NOT NULL
            AND (detail.`status` = 1 OR detail.`status` = 4)
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
        </where>
        GROUP BY event_id
        ) temp
    </select>

    <!-- 困人工单历史 -->
    <select id="theHistoryOfSingleLabor" resultType="java.util.Map">
        SELECT
        envent.register_number AS register_number,
        ele.v_elevator_name AS elevator_name,
        envent.occur_time,
        SUBSTRING( envent.reporter, 6 ) AS fault_id,
        file.v_url as file_url
        FROM
        tbl_third_party_ruijin_envent envent
        LEFT JOIN tbl_sys_file file ON file.v_business_id = SUBSTRING( envent.reporter, 6 )
        AND file.v_file_type = 1 AND file.i_business_type=2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            envent.event_type = 2
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            GROUP BY envent.reporter
            order by envent.occur_time desc
        </where>
    </select>

    <select id="searchUncivilizedBehavior" resultType="java.util.Map">
        SELECT definition.fault_type,
               definition.fault_name,
               0 AS number
        FROM `tbl_fault_definition_0902` definition
        WHERE definition.fault_type = 20
           or definition.fault_type = 38
           or definition.fault_type = 39
        order by definition.fault_type
    </select>

    <!-- 本年度不文明行为走势-->
    <select id="trendOfUncivilizedBehaviorInThisYear" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                fault.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            </otherwise>
        </choose>
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 12 month ) <= fault.dt_report_time]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        <if test="vProjectId != null and vProjectId != ''">
            AND ele.v_project_id = #{vProjectId}
        </if>
        GROUP BY name,date

        union

        select
        '运行次数' as name,
        date_format( ele_rd.dt_report_date, '%Y-%m' ) AS date,
        sum(ele_rd.bi_run_count) as number
        from tbl_elevator_run_count as ele_rd
        join tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= ele_rd.dt_report_date]]>
            <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY name,date

        union

        SELECT
        '急修次数' AS name,
        date_format( event.occur_time, '%Y-%m' ) AS date,
        COUNT(1) as number
        FROM
        tbl_third_party_ruijin_envent `event`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `event`.register_number AND `event`.current_status IN (5,6)
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= `event`.occur_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

        UNION

        SELECT
        '维保次数' as name,
        date_format( workOrder.complete_time, '%Y-%m' ) AS date,
        COUNT(1) AS number
        FROM
        tbl_third_party_ruijin_work_order `workOrder`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `workOrder`.register_number AND `workOrder`.order_status = 40
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= `workOrder`.complete_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

        UNION

        SELECT
        '客流量' as name,
        date_format( rc.dt_report_date, '%Y-%m' ) AS date,
        SUM(rc.passenger_flow) AS number
        FROM
        tbl_elevator_run_count rc
        JOIN tbl_elevator ele ON ele.v_elevator_code = rc.v_elevator_code
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= rc.dt_report_date]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date
    </select>

    <!-- 本年度不文明行为走势-->
    <select id="trendOfUncivilizedBehaviorInThisYearV1" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                fault.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            </otherwise>
        </choose>
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 12 month ) <= fault.dt_report_time]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date

        union

        select
        '运行次数' as name,
        date_format( ele_rd.dt_report_date, '%Y-%m' ) AS date,
        sum(ele_rd.bi_run_count) as number
        from tbl_elevator_run_count as ele_rd
        join tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= ele_rd.dt_report_date]]>
            <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY name,date

        union

        SELECT
        '检修次数' as name,
        date_format( temp.d_report_date, '%Y-%m' ) AS date,
        coalesce (sum(ifNULL(temp.cnt, 0)), 0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        inner JOIN (
        SELECT
        fault.i_fault_type,
        fault.d_report_date,
        case
        when fault.i_fault_num >= 1 then 1
        else 0
        end AS cnt
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <where>
            (fault.i_fault_type = 6 or fault.i_fault_type = 29)
            AND <![CDATA[DATE_SUB(CURDATE(), INTERVAL 12 month) <= fault.dt_report_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        group by fault.d_report_date
        ) temp ON temp.i_fault_type = definition.fault_type
        group by name, date
    </select>


    <!-- 本年度不文明行为走势 骋隆-->
    <select id="trendOfUncivilizedBehaviorInThisYearForCl" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        WHERE
        (fault.i_fault_type = 20 or fault.i_fault_type = 37)
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 12 MONTH) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date
    </select>

    <!-- 前一月不文明行为走势 -->
    <select id="trendOfUncivilizedBehaviorInThePreviousMonth" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                fault.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            </otherwise>
        </choose>
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        <if test="vProjectId != null and vProjectId != ''">
            AND ele.v_project_id = #{vProjectId}
        </if>
        GROUP BY name,date

        union

        select
        '运行次数' as name,
        date_format( ele_rd.dt_report_date, '%Y-%m-%d' ) AS date,
        sum(ele_rd.bi_run_count) as number
        from tbl_elevator_run_count as ele_rd
        join tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
            <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY name,date

        union

        SELECT
        '急修次数' as name,
        date_format( event.occur_time, '%Y-%m-%d' ) AS date,
        COUNT(1) as number
        FROM
        tbl_third_party_ruijin_envent `event`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `event`.register_number AND `event`.current_status IN (5,6)
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `event`.occur_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

        UNION

        SELECT
        '维保次数' as name,
        date_format( workOrder.complete_time, '%Y-%m-%d' ) AS date,
        COUNT(1) AS number
        FROM
        tbl_third_party_ruijin_work_order `workOrder`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `workOrder`.register_number AND `workOrder`.order_status = 40
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `workOrder`.complete_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

        UNION

        SELECT
        '客流量' as name,
        rc.dt_report_date AS date,
        SUM(rc.passenger_flow) AS number
        FROM
        tbl_elevator_run_count rc
        JOIN tbl_elevator ele ON ele.v_elevator_code = rc.v_elevator_code
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= rc.dt_report_date]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

    </select>

    <!-- 前一月不文明行为走势 -->
    <select id="trendOfUncivilizedBehaviorInThePreviousMonthV1" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                fault.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            </otherwise>
        </choose>
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date

        union

        select
        '运行次数' as name,
        date_format( ele_rd.dt_report_date, '%Y-%m-%d' ) AS date,
        sum(ele_rd.bi_run_count) as number
        from tbl_elevator_run_count as ele_rd
        join tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= ele_rd.dt_report_date]]>
            <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY name,date

        union

        SELECT
        '检修次数' as name,
        date_format( temp.dt_report_time, '%Y-%m-%d' ) AS date,
        coalesce((ifNULL(temp.cnt, 0)),0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        inner JOIN (
        SELECT
        fault.i_fault_type,
        fault.dt_report_time,
        case
        when fault.i_fault_num >= 1 then 1
        else 0
        end AS cnt
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <where>
            (fault.i_fault_type = 6 or fault.i_fault_type = 29)
            AND <![CDATA[DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        group by fault.d_report_date
        ) temp ON temp.i_fault_type = definition.fault_type
        group by name, date
    </select>

    <!-- 前一月不文明行为走势 骋隆-->
    <select id="trendOfUncivilizedBehaviorInThePreviousMonthForCl" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        WHERE
        (fault.i_fault_type = 20 or fault.i_fault_type = 37)
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date
    </select>

    <!-- 前一周不文明行为走势 -->
    <select id="trendOfUncivilizedBehaviorInThePreviousWeek" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                fault.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            </otherwise>
        </choose>
        and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        <if test="vProjectId != null and vProjectId != ''">
            AND ele.v_project_id = #{vProjectId}
        </if>
        GROUP BY name,date

        union

        select
        '运行次数' as name,
        date_format( ele_rd.dt_report_date, '%Y-%m-%d' ) AS date,
        sum(ele_rd.bi_run_count) as number
        from tbl_elevator_run_count as ele_rd
        join tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 8 DAY) <= ele_rd.dt_report_date ]]>
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 1 DAY) >= ele_rd.dt_report_date ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        <if test="vProjectId != null and vProjectId != ''">
            AND ele.v_project_id = #{vProjectId}
        </if>
        GROUP BY name,date

        union

        SELECT
        '急修次数' AS name,
        date_format( event.occur_time, '%Y-%m-%d' ) AS date,
        COUNT(1) as number
        FROM
        tbl_third_party_ruijin_envent `event`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `event`.register_number AND `event`.current_status IN (5,6)
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `event`.occur_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

        UNION

        SELECT
        '维保次数' as name,
        date_format( workOrder.complete_time, '%Y-%m-%d' ) AS date,
        COUNT(1) AS cnumber
        FROM
        tbl_third_party_ruijin_work_order `workOrder`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `workOrder`.register_number AND `workOrder`.order_status = 40
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `workOrder`.complete_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

        UNION

        SELECT
        '客流量' as name,
        rc.dt_report_date AS date,
        SUM(rc.passenger_flow) AS number
        FROM
        tbl_elevator_run_count rc
        JOIN tbl_elevator ele ON ele.v_elevator_code = rc.v_elevator_code
        <where>
            <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= rc.dt_report_date]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY date

    </select>

    <!-- 前一周不文明行为走势 -->
    <select id="trendOfUncivilizedBehaviorInThePreviousWeekV1" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        WHERE
        <choose>
            <when test="faultTypes != null and faultTypes.size() > 0">
                fault.i_fault_type in
                <foreach collection="faultTypes" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </when>
            <otherwise>
                (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            </otherwise>
        </choose>
        and <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date

        union

        select
        '运行次数' as name,
        date_format( ele_rd.dt_report_date, '%Y-%m-%d' ) AS date,
        sum(ele_rd.bi_run_count) as number
        from tbl_elevator_run_count as ele_rd
        join tbl_elevator ele ON ele.v_elevator_code = ele_rd.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= ele_rd.dt_report_date ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date

        union

        SELECT
        '检修次数' as name,
        date_format( temp.d_report_date, '%Y-%m-%d' ) AS date,
        coalesce (sum(ifNULL(temp.cnt, 0)), 0) AS number
        FROM
        `tbl_fault_definition_0902` definition
        LEFT JOIN (
        SELECT
        fault.i_fault_type,
        fault.d_report_date,
        case
        when fault.i_fault_num >= 1 then 1
        else 0
        end AS cnt
        FROM
        tbl_fault fault
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <!--<if test="!isAdminFlag">-->
        <!--join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =-->
        <!--#{userId}-->
        <!--</if>-->
        <where>
            (fault.i_fault_type = 6 or fault.i_fault_type = 29)
            AND <![CDATA[DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        group by fault.d_report_date
        ) temp ON temp.i_fault_type = definition.fault_type
        group by name, date
    </select>

    <!-- 前一周不文明行为走势 骋隆-->
    <select id="trendOfUncivilizedBehaviorInThePreviousWeekForCl" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( fault.dt_report_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_fault fault
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = fault.i_fault_type AND
        definition.uncivilized_behavior_flag = 1
        JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id AND ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        WHERE
        (fault.i_fault_type = 20 or fault.i_fault_type = 37)
        and <![CDATA[ DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date
    </select>

    <!-- 电梯故障工单走势图 年度 -->
    <select id="failureWorkOrderTrendChart" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        <if test="timeFlag == '00'">
            date_format( envent.occur_time, '%Y-%m-%d' ) AS date,
        </if>
        <if test="timeFlag == '11'">
            date_format( envent.occur_time, '%Y-%m-%d' ) AS date,
        </if>
        <if test="timeFlag == '22'">
            date_format( envent.occur_time, '%Y-%m' ) AS date,
        </if>
        count( 1 ) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code AND
        definition.platform_type = 2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            envent.event_type = 1
            AND envent.current_status IN (5,6)
            <if test="currentStatus != null and currentStatus != ''">
                AND envent.current_status = #{currentStatus}
            </if>
            <if test="timeFlag == '00'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 6 DAY ) <= envent.occur_time ]]>
            </if>
            <if test="timeFlag == '11'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 29 DAY ) <= envent.occur_time ]]>
            </if>
            <if test="timeFlag == '22'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 11 MONTH ) <= envent.occur_time ]]>
            </if>
            <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY name,date
    </select>

    <!-- 电梯故障工单走势图 月度 -->
    <select id="monthlyTrendChartOfFaultWorkOrder" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( envent.occur_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code AND
        definition.platform_type = 2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        WHERE
        envent.event_type = 1
        AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 30 DAY ) <= envent.occur_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date
    </select>

    <!-- 电梯故障工单走势图 周 -->
    <select id="elevatorFaultWorkOrderTrendChartWeek" resultType="java.util.HashMap">
        SELECT
        definition.fault_name AS name,
        date_format( envent.occur_time, '%Y-%m-%d' ) AS date,
        count( 1 ) AS number
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code AND
        definition.platform_type = 2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        WHERE
        envent.event_type = 1
        AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 7 DAY ) <= envent.occur_time ]]>
        <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
            AND ele.v_village_id = #{villageId}
        </if>
        GROUP BY name,date
    </select>

    <!-- 历史维保数据走势 年 -->
    <select id="trendYearOfHistoricalMaintenanceData" resultType="java.util.LinkedHashMap">
        select * from (
        SELECT
        '正常维保' AS order_type_name,
        CONCAT(YEAR(`order`.should_complete_date),'-', date_format(`order`.should_complete_date, '%m')) AS `date`,
        count(1) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        <if test="!isAdminFlag">
            JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
            Date ( `order`.complete_time )<= Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
            and DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= `order`.should_complete_date
            ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY MONTH(`order`.should_complete_date)

        UNION

        SELECT
        '超期维保' AS order_type_name,
        CONCAT(YEAR(`order`.should_complete_date),'-', date_format(`order`.should_complete_date, '%m')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        <if test="!isAdminFlag">
            JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
             Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
             AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= `order`.should_complete_date
             ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY MONTH(`order`.should_complete_date)

        UNION

        SELECT
        '缺失维保' AS order_type_name,
        CONCAT(YEAR(`order`.dt_create_time),'-', date_format(`order`.dt_create_time, '%m'),
        '-',date_format(`order`.dt_create_time, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ `order`.complete_time  is null AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= `order`.dt_create_time ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY MONTH(`order`.dt_create_time)
        ) temp order by temp.`date`
    </select>

    <!-- 历史维保数据走势 月 -->
    <select id="historicalMaintenanceDataTrendMonth" resultType="java.util.LinkedHashMap">
        select * from (
        SELECT
        '正常维保' AS order_type_name,
        CONCAT(YEAR(`order`.should_complete_date),'-', date_format(`order`.should_complete_date, '%m'), '-',
        date_format(`order`.should_complete_date, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        <if test="!isAdminFlag">
            JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
            Date ( `order`.complete_time )<= Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
            and DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.should_complete_date
            ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY DAY(`order`.should_complete_date)

        UNION

        SELECT
        '超期维保' AS order_type_name,
        CONCAT(YEAR(`order`.should_complete_date),'-', date_format(`order`.should_complete_date, '%m'),
        '-',date_format(`order`.should_complete_date, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        <if test="!isAdminFlag">
            JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
             Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
             AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.should_complete_date
             ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY DAY(`order`.should_complete_date)

        UNION

        SELECT
        '缺失维保' AS order_type_name,
        CONCAT(YEAR(`order`.dt_create_time),'-', date_format(`order`.dt_create_time, '%m'),
        '-',date_format(`order`.dt_create_time, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ `order`.complete_time  is null AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.dt_create_time ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY DAY(`order`.dt_create_time)
        ) temp order by temp.`date`
    </select>

    <!-- 历史维保数据走势 周 -->
    <select id="trendWeekOfHistoricalMaintenanceData" resultType="java.util.LinkedHashMap">
        select * from (
        SELECT
        '正常维保' AS order_type_name,
        CONCAT(YEAR(`order`.should_complete_date),'-', date_format(`order`.should_complete_date, '%m'), '-',
        date_format(`order`.should_complete_date, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        <if test="!isAdminFlag">
            JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
            Date ( `order`.complete_time )<= Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
            and DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `order`.should_complete_date
            ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY DAY(`order`.should_complete_date)

        UNION

        SELECT
        '超期维保' AS order_type_name,
        CONCAT(YEAR(`order`.should_complete_date),'-', date_format(`order`.should_complete_date, '%m'),
        '-',date_format(`order`.should_complete_date, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        <if test="!isAdminFlag">
            JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
             Date ( IFNULL(`order`.complete_time,CURDATE())) > Date (DATE_ADD(`order`.should_complete_date, INTERVAL 2 DAY))
             AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= `order`.should_complete_date
             ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY DAY(`order`.should_complete_date)

        UNION

        SELECT
        '缺失维保' AS order_type_name,
        CONCAT(YEAR(`order`.dt_create_time),'-', date_format(`order`.dt_create_time, '%m'),
        '-',date_format(`order`.dt_create_time, '%d')) AS `date`,
        COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ `order`.complete_time is null AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= `order`.dt_create_time ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        GROUP BY DAY(`order`.dt_create_time)
        ) temp order by temp.`date`
    </select>

    <!-- 获取电梯数量接口 -->
    <select id="countElevator" resultType="java.util.Map">
        SELECT 'totalQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="villageId != 'null' and villageId != 'undefined'">
                ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'totalQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="villageId != 'null' and villageId != 'undefined'">
                ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT 'onlineQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id AND td.v_sensor_type != 'CarRoof'
        <where>
            td.i_online_status = 1
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'onlineQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id AND td.v_sensor_type != 'CarRoof'
        <where>
            td.i_online_status = 1
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT 'iotElevators' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id AND td.v_sensor_type != 'CarRoof'
        <where>
            ele.i_install_status in (1, 3)
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT 'iotElevatorStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id AND td.v_sensor_type != 'CarRoof'
        <where>
            ele.i_install_status in (1, 3)
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT 'offlineQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id
        AND td.v_sensor_type != 'CarRoof'
        <where>
            ele.i_install_status in (1, 3) AND td.i_online_status = '0'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'offlineQuantityStr' AS `key`, GROUP_CONCAT(DISTINCT ele.v_elevator_name) AS `number` FROM `tbl_elevator`
        ele
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id AND td.v_sensor_type != 'CarRoof'
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_install_status in (1, 3) AND td.i_online_status = '0'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        SELECT 'overhaulQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_mode_status = '1'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'overhaulQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_mode_status = '1'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        SELECT 'faultQuantity' AS `key`, count(distinct ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ envent.current_status < 5 ]]>
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'faultQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ envent.current_status < 5 ]]>
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        select
        'oldAndWornOut' AS `key`, count( ele.v_elevator_id ) AS `number`
        From
        `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            DATE_FORMAT(NOW(), '%Y%m%d00') > v_equipment_code%10000000000 + 15000000
            <if test="villageId != null and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        select
        'oldAndWornOutStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number`
        From
        `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            DATE_FORMAT(NOW(), '%Y%m%d00') > v_equipment_code%10000000000 + 15000000
            <if test="villageId != null and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
    </select>

    <!-- 获取电梯数量接口v1 -->
    <select id="countElevatorV1" resultType="java.util.Map">
        SELECT 'maintenanceCount' AS `key`, COUNT(`order`.work_order_number) AS number
        FROM
        tbl_third_party_ruijin_work_order `order`
        JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
             DATE_FORMAT(`order`.complete_time, '%Y%m') = DATE_FORMAT(CURDATE(),'%Y%m')
             ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT
        'maintenanceCountStr' AS `key`,
        GROUP_CONCAT(ele.v_elevator_name) AS `number`
        FROM
        tbl_third_party_ruijin_work_order `order`
        JOIN tbl_elevator ele on ele.v_equipment_code = `order`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[
             DATE_FORMAT(`order`.complete_time, '%Y%m') = DATE_FORMAT(CURDATE(),'%Y%m')
             ]]>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
        union
        SELECT 'totalQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="villageId != 'null' and villageId != 'undefined'">
                ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION
        SELECT 'totalQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <if test="villageId != 'null' and villageId != 'undefined'">
                ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        SELECT 'onlineQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_on_line = '1'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'onlineQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_on_line = '1'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        SELECT 'offlineQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_on_line = '0'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'offlineQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_on_line = '0'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        SELECT 'overhaulQuantity' AS `key`, count(ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_mode_status = '1'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'overhaulQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            ele.i_mode_status = '1'
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        SELECT 'faultQuantity' AS `key`, count(distinct ele.v_elevator_id) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ envent.current_status < 5 ]]>
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        SELECT 'faultQuantityStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number` FROM `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        join tbl_third_party_ruijin_envent envent on envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            <![CDATA[ envent.current_status < 5 ]]>
            <if test="villageId != 'null' and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION

        select
        'oldAndWornOut' AS `key`, count( ele.v_elevator_id ) AS `number`
        From
        `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            DATEDIFF((SELECT now()),ele.dt_create_time) >= 730
            <if test="villageId != null and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        UNION
        select
        'oldAndWornOutStr' AS `key`, GROUP_CONCAT(ele.v_elevator_name) AS `number`
        From
        `tbl_elevator` ele
        join tbl_third_party_ruijin_elevator eleRuijin on eleRuijin.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            DATEDIFF((SELECT now()),ele.dt_create_time) >= 730
            <if test="villageId != null and villageId != 'undefined'">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
    </select>


    <!-- 查询故障列表 -->
    <select id="searchFaultList" resultType="java.util.Map">
        SELECT
        SUBSTRING( envent.reporter, 6 ) AS v_fault_id,
        ele.v_elevator_id,
        ele.v_elevator_code,
        ele.v_equipment_code as registerNumber,
        ele.v_elevator_name,
        ele.v_address,
        ele.v_village_id as villageId,
        village.v_village_name as villageName,
        envent.occur_time as dt_report_time,
        envent.failure_code as i_fault_type,
        envent.event_number as eventNumber,
        envent.event_id as eventId,
        definition.fault_name as v_fault_name,
        envent.current_status as i_status
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code and
        definition.platform_type=2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        JOIN tbl_village village on village.v_village_id = ele.v_village_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
            </if>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and DATE_FORMAT(envent.occur_time,'%Y-%m-%d') >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and DATE_FORMAT(envent.occur_time,'%Y-%m-%d') <=  #{dtEndTime} ]]>
            </if>
            <if test="iStatus != null">
                and envent.current_status = #{iStatus}
            </if>
            <!--待急修，新建 + 已接单 + 已签到 -->
            <if test="overdue != null and overdue == 2 ">
                and envent.current_status IN (2,3,4)
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and envent.failure_code = #{iFaultType}
            </if>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <!--<if test="vEventType != null and vEventType != ''">
                and envent.event_type = #{vEventType}
            </if>-->
        </where>
        order by occur_time desc
    </select>

    <!-- 查询故障列表 -->
    <select id="searchFaultListDownload" resultType="com.shmashine.api.module.fault.output.QueryFaultExportModule">
        SELECT
        ele.v_elevator_code as vElevatorCode,
        ele.v_elevator_name as vElevatorName,
        ele.v_address as vAddress,
        village.v_village_name as vVillageName,
        project.v_project_name as vProjectName,
        envent.occur_time as dtReportTime,
        definition.fault_name as vFaultName,
        case envent.current_status
        when 1 then '渠道上报'
        when 2 then '新建工单'
        when 3 then '已接单'
        when 4 then '已签到'
        when 5 then '已完成'
        when 6 then '已确认'
        when 7 then '误报'
        when 8 then '事故'
        end as vStatusName
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code and
        definition.platform_type=2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        JOIN tbl_village village on village.v_village_id = ele.v_village_id
        join tbl_project project on project.v_project_id = ele.v_project_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
            </if>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and DATE_FORMAT(envent.occur_time,'%Y-%m-%d') >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and DATE_FORMAT(envent.occur_time,'%Y-%m-%d') <=  #{dtEndTime} ]]>
            </if>
            <if test="iStatus != null">
                and envent.current_status = #{iStatus}
            </if>
            <!--待急修，新建 + 已接单 + 已签到 -->
            <if test="overdue != null and overdue == 2 ">
                and envent.current_status IN (2,3,4)
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and envent.failure_code = #{iFaultType}
            </if>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <!--<if test="vEventType != null and vEventType != ''">
                and envent.event_type = #{vEventType}
            </if>-->
        </where>
        order by occur_time desc
        limit 0, 500
    </select>

    <!-- 获取维保记录列表 -->
    <select id="searchMaintenanceList" resultType="java.util.Map">
        SELECT
        o.id,
        o.register_number,
        ele.v_elevator_code,
        ele.v_elevator_name,
        ele.v_address,
        o.should_complete_date as should_complete_date,
        o.complete_time as complete_time,
        o.next_maintenance_date as next_maintenance_date,
        o.work_order_number as workOrderNumber,
        o.deal_employee_name as deal_employee_name,
        o.order_type_number as order_type_number,
        o.order_status as i_status
        FROM
        tbl_third_party_ruijin_work_order o
        JOIN tbl_elevator ele ON o.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and (
                ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
                or ele.v_elevator_name like CONCAT('%',#{vElevatorCode},'%')
                )
            </if>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and o.complete_time >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and o.complete_time <=  #{dtEndTime} ]]>
            </if>
            <if test="iStatus != null">
                and o.order_status = #{iStatus}
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and o.order_type_number = #{iFaultType}
            </if>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        order by complete_time desc
    </select>

    <!-- 查询最新困人中的记录 -->
    <select id="getPersonShuttingLately" resultType="java.util.Map">
        SELECT
        envent.event_id,
        envent.register_number,
        SUBSTRING( envent.reporter, 6 ) AS v_fault_id,
        ele.v_building_id,
        ele.v_elevator_code,
        ele.v_elevator_name,
        ele.v_address,
        ele.v_village_id,
        ele.v_elevator_id,
        envent.occur_time as dt_report_time,
        envent.failure_code as i_fault_type,
        envent.current_status
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            envent.event_type = 2 AND to_days(occur_time) = to_days(now()) AND
            <![CDATA[
                envent.current_status <5
            ]]>
        </where>
        order by occur_time desc limit 1
    </select>

    <!-- 查询瑞金事件 -->
    <select id="searchEventsForDownload" resultMap="eventDownloadModuleMap">
        SELECT
        ele.v_elevator_name,
        ele.v_address,
        envent.occur_time as dt_report_time,
        definition.fault_name as v_fault_name,
        envent.current_status as i_status
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_fault_definition_0902 definition ON definition.fault_type = envent.failure_code and
        definition.platform_type=2
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
            </if>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and envent.occur_time >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and envent.occur_time <=  #{dtEndTime} ]]>
            </if>
            <if test="iStatus != null">
                and envent.current_status = #{iStatus}
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and envent.failure_code = #{iFaultType}
            </if>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
        </where>
        order by v_elevator_name,occur_time desc
    </select>

    <select id="getTrappedPeopleTime" resultType="java.lang.Integer">
        SELECT
        avg( TIMESTAMPDIFF( SECOND, temp.start_time, temp.end_time ) ) AS number
        FROM
        (
        SELECT
        detail.event_id,
        max( detail.status_time ) AS end_time,
        min( detail.status_time ) AS start_time
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
            AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
        </if>
        JOIN tbl_third_party_ruijin_envent_detail detail ON detail.event_id = envent.event_id
        <where>
            envent.event_type = 2
            AND envent.rescue_company_name IS NOT NULL
            AND (detail.`status` = 1 OR detail.`status` = 5)
            <if test="faultStatisticalQuantitySearchModule.timeFlag != null and faultStatisticalQuantitySearchModule.timeFlag != ''">
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= envent.occur_time]]>
                </if>
                <if test="faultStatisticalQuantitySearchModule.timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= envent.occur_time]]>
                </if>
            </if>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.elevatorCode != null and faultStatisticalQuantitySearchModule.elevatorCode != ''">
                AND ele.v_elevator_code = #{faultStatisticalQuantitySearchModule.elevatorCode}
            </if>
        </where>
        GROUP BY event_id
        ) temp
    </select>

    <select id="searchFaultCount" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            envent.occur_time BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AND NOW()
            and envent.current_status = 6
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
        </where>
    </select>

    <select id="searchtrappedPeopleCount" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        tbl_third_party_ruijin_envent envent
        JOIN tbl_elevator ele ON envent.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            envent.occur_time BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR) AND NOW()
            and envent.current_status = 6
            and envent.failure_code = 09
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
        </where>
    </select>

    <!--反复阻挡门统计-->
    <select id="queryStopCount" resultType="java.lang.Integer">
        select
        count(1)
        from
        tbl_fault fault
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on fault.v_elevator_id = resource.v_resource_id and v_user_id =
            #{userId}
        </if>
        left join tbl_elevator ele on ele.v_elevator_id = fault.v_elevator_id
        <where>
            fault.i_uncivilized_behavior_flag = 1
            and fault.dt_report_time BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AND NOW()
            and fault.i_fault_type = 20
            and fault.i_del_flag = 0
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
        </where>
    </select>

    <!--运行次数统计-->
    <select id="getRunCount" resultType="java.lang.Integer">
        select
        AVG(tr.bi_run_count)/24
        from
        tbl_elevator_run_count tr
        left join tbl_elevator ele on ele.v_elevator_code = tr.v_elevator_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            tr.dt_report_date >= DATE_SUB(CURDATE(), INTERVAL 31 DAY)
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
        </where>
    </select>

    <!--获取本年度维保记录-->
    <select id="getOverdueOrders" resultType="java.util.Map">
        SELECT
        `order`.id,
        DATE( `order`.complete_time ) AS complete_time,
        DATE( `order`.next_maintenance_date ) AS next_maintenance_date,
        `order`.register_number,
        ele.v_elevator_name AS elevator_name
        FROM
        `tbl_third_party_ruijin_work_order` `order`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `order`.register_number
        <if test="!faultStatisticalQuantitySearchModule.isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{faultStatisticalQuantitySearchModule.userId}
        </if>
        <where>
            <![CDATA[ DATE_FORMAT(CURDATE(), '%Y-01-01 00:00:00') <= `order`.complete_time ]]>
            <if test="faultStatisticalQuantitySearchModule.villageId != null and faultStatisticalQuantitySearchModule.villageId != ''">
                AND ele.v_village_id = #{faultStatisticalQuantitySearchModule.villageId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.vProjectId != null and faultStatisticalQuantitySearchModule.vProjectId != ''">
                AND ele.v_project_id = #{faultStatisticalQuantitySearchModule.vProjectId}
            </if>
            <if test="faultStatisticalQuantitySearchModule.elevatorCode != null and faultStatisticalQuantitySearchModule.elevatorCode != ''">
                AND ele.v_elevator_code = #{faultStatisticalQuantitySearchModule.elevatorCode}
            </if>
        </where>
        ORDER BY register_number, complete_time
    </select>

    <!--获取当日困人电梯-->
    <select id="getTodayTrappedPeopleEleName" resultType="java.lang.String">
        SELECT ele.v_elevator_name FROM tbl_third_party_ruijin_envent tre
        INNER JOIN tbl_elevator ele ON tre.register_number = ele.v_equipment_code
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            tre.failure_code = 09
            AND tre.occur_time >= DATE_FORMAT(NOW(), '%Y-%m-%d 00:00:00')
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
        </where>
    </select>

    <!--电梯故障占比-儿童医院项目只统计平台故障-->
    <select id="statisticsFaultPovertyByMX" resultType="java.util.Map">
        SELECT
        tf.i_fault_type AS i_fault_type,
        tf.v_fault_name AS v_fault_name,
        count(*) AS `number`
        FROM
        tbl_fault tf
        join tbl_elevator ele on tf.i_uncivilized_behavior_flag = 0 and tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>

        <where>
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= tf.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= tf.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= tf.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            and tf.i_del_flag = 0
        </where>
        GROUP BY
        tf.i_fault_type
        ORDER BY `number` DESC
    </select>

    <!--电梯故障工单走势图——儿童医院项目只统计平台数据-->
    <select id="failureWorkOrderTrendChartByMX" resultType="java.util.Map">
        SELECT
        tf.v_fault_name AS name,
        <if test="timeFlag == '00'">
            date_format( tf.d_report_date, '%Y-%m-%d' ) AS date,
        </if>
        <if test="timeFlag == '11'">
            date_format( tf.d_report_date, '%Y-%m-%d' ) AS date,
        </if>
        <if test="timeFlag == '22'">
            date_format( tf.d_report_date, '%Y-%m' ) AS date,
        </if>
        count( 1 ) AS number
        FROM
        tbl_fault tf
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            tf.i_uncivilized_behavior_flag = 0
            <if test="timeFlag == '00'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 7 DAY ) <= tf.dt_report_time ]]>
            </if>
            <if test="timeFlag == '11'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 30 DAY ) <= tf.dt_report_time ]]>
            </if>
            <if test="timeFlag == '22'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 12 MONTH ) <= tf.dt_report_time ]]>
            </if>
            <if test="villageId != null and villageId != '' and villageId != 'null' and villageId != 'undefined'">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            and tf.i_del_flag = 0
        </where>
        GROUP BY name,date
    </select>

    <!--儿童医院项目——故障频次统计麦信平台故障-->
    <select id="searchFaultCountForMX" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        tbl_fault tf
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            tf.dt_report_time BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 MONTH) AND NOW()
            and tf.i_uncivilized_behavior_flag = 0
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
        </where>
        GROUP BY tf.d_report_date,tf.i_fault_type,ele.v_elevator_code
    </select>

    <!--儿童医院项目——困人频次统计麦信平台故障-->
    <select id="searchtrappedPeopleCountForMX" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        tbl_fault tf
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            tf.dt_report_time BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR) AND NOW()
            and (tf.i_fault_type = 7 OR tf.i_fault_type = 8)
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
            and tf.i_del_flag = 0
        </where>
    </select>

    <!--儿童医院项目——救援时长统计麦信平台故障时长-->
    <select id="getTrappedPeopleTimeForMX" resultType="java.lang.Integer">
        SELECT
        AVG(tf.i_duration_time) AS number
        FROM
        tbl_fault tf
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            tf.dt_report_time BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR) AND NOW()
            and (tf.i_fault_type = 7 OR tf.i_fault_type = 8)
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
            and tf.i_del_flag = 0
        </where>
    </select>

    <!--历史困人救援统计——儿童医院项目，统计麦信平台故障-->
    <select id="statisticsOfTrappedPeopleRescueForMX" resultType="java.util.Map">
        SELECT
        '困人历史工单数' AS `key`,
        count(1) AS number
        FROM
        tbl_fault tf
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            (tf.i_fault_type = 7 OR tf.i_fault_type = 8)
            <if test="timeFlag == '00'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 7 DAY ) <= tf.dt_report_time ]]>
            </if>
            <if test="timeFlag == '11'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 30 DAY ) <= tf.dt_report_time ]]>
            </if>
            <if test="timeFlag == '22'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 12 MONTH ) <= tf.dt_report_time ]]>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
            and tf.i_del_flag = 0
        </where>

        UNION

        SELECT
        '救援解困平均时间' AS `key`,
        AVG(tf.i_duration_time)/1000 AS `number`
        FROM
        tbl_fault tf
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            (tf.i_fault_type = 7 OR tf.i_fault_type = 8)
            <if test="timeFlag == '00'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 7 DAY ) <= tf.dt_report_time ]]>
            </if>
            <if test="timeFlag == '11'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 30 DAY ) <= tf.dt_report_time ]]>
            </if>
            <if test="timeFlag == '22'">
                AND <![CDATA[ DATE_SUB( CURDATE( ), INTERVAL 12 MONTH ) <= tf.dt_report_time ]]>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and elevatorCode != ''">
                AND ele.v_elevator_code = #{elevatorCode}
            </if>
            and tf.i_del_flag = 0
        </where>
    </select>

    <!--儿童医院项目——历史困人工单统计平台故障-->
    <select id="theHistoryOfSingleLaborForMX" resultType="java.util.Map">
        SELECT
        ele.v_equipment_code AS register_number,
        ele.v_elevator_name AS elevator_name,
        tf.dt_report_time,
        tf.v_fault_id AS fault_id,
        file.v_url as file_url
        FROM
        tbl_fault tf
        LEFT JOIN tbl_sys_file file ON file.v_business_id = tf.v_fault_id
        AND file.v_file_type = 1
        JOIN tbl_elevator ele ON tf.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>
            (tf.i_fault_type = 7 OR tf.i_fault_type = 8)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= tf.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= tf.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= tf.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            and tf.i_del_flag = 0
        </where>

        order by tf.dt_report_time desc
    </select>

    <!--电梯基础数据-->
    <select id="getRunCountInfo1" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        ele.v_elevator_code,
        ele.v_elevator_name,
        ele.v_equipment_code,
        elebd.v_elevator_brand_name AS brandName,
        ele.i_elevator_type AS i_elevator_type,
        sysinfo.v_name_zh_cn AS i_elevator_type_name,
        ele.i_elevator_use_type,
        sysinfo1.v_name_zh_cn AS i_elevator_use_type_name,
        ele.d_last_maintain_date,
        ele.d_next_inspect_date
        FROM
        tbl_elevator ele
        LEFT JOIN tbl_elevator_brand elebd on ele.v_elevator_brand_id = elebd.v_elevator_brand_id
        left join tbl_sys_systeminfo sysinfo on sysinfo.v_sysvalue5 = ele.i_elevator_type and sysinfo.v_sysid = '10002'
        left join tbl_sys_systeminfo sysinfo1 on sysinfo1.v_sysvalue5 = ele.i_elevator_use_type and sysinfo1.v_sysid =
        '10023'
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        <if test="elevatorCode != null and !elevatorCode.isEmpty()">
            AND ele.v_elevator_code IN
            <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                #{code}
            </foreach>
        </if>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--电梯基础运行数据统计-->
    <select id="getRunCountInfo2" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        SUM(tc.bi_run_count) AS run_count,
        SUM(tc.bi_door_count) AS door_count,
        SUM(tc.bi_run_distance_count) AS distance_count,
        SUM(tc.bi_bend_count) AS bend_count
        FROM
        tbl_elevator ele
        LEFT JOIN tbl_elevator_run_count tc ON tc.v_elevator_code = ele.v_elevator_code
        <where>
            <if test="dtReportTime != null and dtReportTime != ''">
                AND tc.dt_report_date &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND tc.dt_report_date &lt;= #{dtEndTime}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and !elevatorCode.isEmpty()">
                AND ele.v_elevator_code IN
                <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--困人故障数据统计-->
    <select id="getRunCountInfo3" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        sum(case when evt.event_type = 1 then 1 else 0 end) AS fault,
        sum(case when evt.event_type = 2 then 1 else 0 end) AS rescue
        FROM
        tbl_elevator ele
        LEFT JOIN tbl_third_party_ruijin_envent evt ON evt.register_number = ele.v_equipment_code
        <where>
            evt.current_status = 6
            <if test="dtReportTime != null and dtReportTime != ''">
                AND DATE_FORMAT(evt.occur_time,'%Y-%m-%d') &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND DATE_FORMAT(evt.occur_time,'%Y-%m-%d') &lt;= #{dtEndTime}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and !elevatorCode.isEmpty()">
                AND ele.v_elevator_code IN
                <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--困人故障数据统计-->
    <select id="getRunCountInfo3Mx" resultType="java.util.Map">
        SELECT
        distinct ele.v_elevator_id,
        sum(case when tf.i_fault_type in ('7', '8', '09') then 1 else 0 end) AS rescue,
        sum(case when tf.i_fault_type not in('7', '8', '09') then 1 else 0 end) AS fault
        FROM
        tbl_elevator ele
        LEFT JOIN tbl_fault tf ON tf.v_elevator_code = ele.v_elevator_code
        <where>
            tf.i_del_flag = 0
            <if test="dtReportTime != null and dtReportTime != ''">
                AND DATE_FORMAT(tf.dt_report_time,'%Y-%m-%d') &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND DATE_FORMAT(tf.dt_report_time,'%Y-%m-%d') &lt;= #{dtEndTime}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and !elevatorCode.isEmpty()">
                AND ele.v_elevator_code IN
                <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--维保次数统计-->
    <select id="getRunCountInfo4" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        COUNT(1) AS workOrderNum
        FROM
        tbl_elevator ele
        LEFT JOIN tbl_third_party_ruijin_work_order workOrder ON workOrder.register_number = ele.v_equipment_code
        <where>
            <if test="dtReportTime != null and dtReportTime != ''">
                AND DATE_FORMAT(workOrder.complete_time,'%Y-%m-%d') &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND DATE_FORMAT(workOrder.complete_time,'%Y-%m-%d') &lt;= #{dtEndTime}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and !elevatorCode.isEmpty()">
                AND ele.v_elevator_code IN
                <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--关门受阻挡次数统计-->
    <select id="getRunCountInfo5" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        COUNT(1) AS doorStopNumber
        FROM
        tbl_fault fault
        INNER JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id
        AND ele.v_elevator_code = fault.v_elevator_code
        <where>
            fault.i_fault_type = 20
            <if test="dtReportTime != null and dtReportTime != ''">
                AND DATE_FORMAT(fault.dt_report_time ,'%Y-%m-%d') &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND DATE_FORMAT(fault.dt_report_time ,'%Y-%m-%d') &lt;= #{dtEndTime}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and !elevatorCode.isEmpty()">
                AND fault.v_elevator_code IN
                <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
            and fault.i_del_flag = 0
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--电动车乘梯次数统计-->
    <select id="getRunCountInfo6" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        COUNT(1) AS electro_mobile_count
        FROM
        tbl_fault fault
        INNER JOIN tbl_elevator ele ON ele.v_elevator_id = fault.v_elevator_id
        AND ele.v_elevator_code = fault.v_elevator_code
        <where>
            fault.i_fault_type = 37
            <if test="dtReportTime != null and dtReportTime != ''">
                AND DATE_FORMAT(fault.dt_report_time ,'%Y-%m-%d') &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND DATE_FORMAT(fault.dt_report_time ,'%Y-%m-%d') &lt;= #{dtEndTime}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="iElevatorType != null and iElevatorType != ''">
                AND ele.i_elevator_use_type = #{iElevatorType}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="elevatorCode != null and !elevatorCode.isEmpty()">
                AND fault.v_elevator_code IN
                <foreach item="code" collection="elevatorCode" open="(" separator="," close=")">
                    #{code}
                </foreach>
            </if>
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--瑞金大屏首页状态-->
    <select id="getElevatorsStatus" resultType="java.util.Map">
        SELECT
        ele.v_elevator_id,
        ele.v_elevator_name,
        td.i_online_status AS i_on_line,
        ele.v_equipment_code as register_number,
        ele.v_village_id as villageId,
        ele.v_elevator_code,
        ele.v_building_id,
        ele.v_address,
        ele.i_mode_status,
        CASE
        WHEN EXISTS (
        SELECT '1' FROM tbl_third_party_ruijin_envent envent WHERE envent.register_number = ele.v_equipment_code
        AND envent.current_status &lt; 5
        AND envent.event_type = '2'
        AND envent.occur_time &gt; curdate()
        ) THEN 2

        WHEN EXISTS (
        SELECT '1' FROM tbl_third_party_ruijin_envent envent WHERE envent.register_number = ele.v_equipment_code
        AND envent.current_status &lt; 5
        AND envent.event_type = '1'
        AND envent.occur_time &gt; curdate()
        ) THEN 1
        ELSE 0 END AS i_fault_status
        FROM tbl_elevator ele
        INNER JOIN tbl_device td ON td.v_elevator_id = ele.v_elevator_id
        AND td.v_sensor_type != 'CarRoof'
        <where>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        GROUP BY ele.v_elevator_id
        ORDER BY ele.v_elevator_name ASC
    </select>

    <!--获取楼宇-->
    <select id="queryBuilding" resultType="java.util.Map">
        SELECT tb.v_building_id,tb.v_building_name,tv.v_village_name
        FROM tbl_building tb
        INNER JOIN tbl_village tv ON tv.v_village_id = tb.v_village_id
        <where>
            <if test="villageId != null and villageId != ''">
                AND tb.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND tv.v_project_id = #{vProjectId}
            </if>
        </where>
    </select>


    <!--获取电梯年检信息-->
    <select id="queryAnnualInspectionList" resultType="java.util.Map">
        select
        ele.v_elevator_name,
        ele.d_last_inspect_date,
        #{overdue} AS overdue
        from tbl_elevator ele
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and v_user_id =
            #{userId}
        </if>
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and ele.v_elevator_code = #{vElevatorCode}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                and ele.v_project_id = #{vProjectId}
            </if>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
            <!--下次年检日期-->
            <if test="dtReportTime != null and dtReportTime != ''">
                AND DATE_FORMAT(ele.d_next_inspect_date ,'%Y-%m-%d') &gt;= #{dtReportTime}
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                AND DATE_FORMAT(ele.d_next_inspect_date ,'%Y-%m-%d') &lt;= #{dtEndTime}
            </if>

            <!--正常年检，下次年检日期大于今年-->
            <if test="overdue != null and overdue == 0 ">
                and ele.d_next_inspect_date &gt;= DATE_SUB(DATE_SUB(CURDATE(),INTERVAL dayofyear(now())-1 DAY), INTERVAL
                -1 YEAR)
            </if>
            <!--待年检，下次年检日期为本月-->
            <if test="overdue != null and overdue == 2 ">
                and ele.d_next_inspect_date &gt;= DATE_SUB(CURDATE(),INTERVAL DAYOFMONTH(now()) -1 DAY)
                and ele.d_next_inspect_date &lt; DATE_SUB(DATE_SUB(CURDATE(),INTERVAL dayofyear(now()) -1 DAY), INTERVAL
                -1 MONTH)
            </if>
            <!--超期，下次年检日期小于本月-->
            <if test="overdue != null and overdue == 1 ">
                and ele.d_next_inspect_date &lt; DATE_SUB(CURDATE(),INTERVAL DAYOFMONTH(now()) -1 DAY)
            </if>

        </where>
        order by ele.v_elevator_name
    </select>

    <!--统计故障次数信息 骋隆 麦信数据源-->
    <select id="statisticsOfFailureTimesForClWithMXData" resultType="java.util.Map">
        SELECT
        '困人统计' AS `name`,
        SUM(fault.i_fault_num) AS `number`
        FROM
        tbl_fault fault
        left join tbl_elevator ele on fault.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on fault.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            (fault.i_fault_type = 7 or fault.i_fault_type = 8)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT
        '故障统计' AS `name`,
        SUM(fault.i_fault_num) AS `number`
        FROM
        tbl_fault fault
        left join tbl_elevator ele on fault.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on fault.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            fault.i_uncivilized_behavior_flag = 0
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>

        UNION

        SELECT
        '不文明行为统计' AS `name`,
        count( 1 ) AS `number`
        FROM
        tbl_fault fault
        join tbl_elevator ele on ele.v_elevator_id = fault.v_elevator_id and ele.v_elevator_code = fault.v_elevator_code
        <if test="!isAdminFlag">
            join tbl_sys_user_resource resource on ele.v_elevator_id = resource.v_resource_id and resource.v_user_id =
            #{userId}
        </if>
        <where>
            (fault.i_fault_type = 20 or fault.i_fault_type = 37)
            <if test="timeFlag != null and timeFlag != ''">
                <if test="timeFlag == '00'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 7 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '11'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 30 DAY) <= fault.dt_report_time]]>
                </if>
                <if test="timeFlag == '22'">
                    <![CDATA[AND DATE_SUB(CURDATE(), INTERVAL 365 DAY) <= fault.dt_report_time]]>
                </if>
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
        </where>
    </select>

    <!--获取电梯基本信息 麦信数据源-->
    <select id="getElevatorInfoWithMXData" resultType="java.util.Map">
        SELECT ele.v_elevator_code,
               ele.v_elevator_name,
               IFNULL(ele.v_address, '--')               AS v_address,
               IFNULL(ele.v_equipment_code, '--')        AS v_equipment_code,
               IFNULL(brand.v_elevator_brand_name, '--') AS v_elevator_brand_name,
               IFNULL(sys.v_name_zh_cn, '--')            AS elevator_type_name,
               IFNULL(sys2.v_name_zh_cn, '--')           AS fault_status,
               IFNULL(ele.d_last_maintain_date, '--')    AS last_maintain_date,
               IFNULL(ele.d_next_inspect_date, '--')     AS next_inspect_date,
               ele.dt_install_time                       AS dt_install_time,
               IFNULL(ele.bi_run_count, '--')            AS bi_run_count,
               IFNULL(ele.bi_door_count, '--')           AS bi_door_count,
               IFNULL(ele.bi_bend_count, '--')           AS bi_bend_count,
               IFNULL(ele.bi_run_distance_count, '--')   AS bi_run_distance_count
        FROM tbl_elevator ele
                 left JOIN tbl_elevator_brand brand on brand.v_elevator_brand_id = ele.v_elevator_brand_id
                 left JOIN tbl_sys_systeminfo sys on sys.v_sysid = '10002' and sys.v_syssubid != '0' and ele.i_elevator_type = sys.v_sysvalue5
        left JOIN tbl_sys_systeminfo sys2
        on sys2.v_sysid = '10018' and sys2.v_syssubid != '0' and ele.i_fault_status = sys2.v_sysvalue5
        where
            ele.v_equipment_code = #{register_number}
        group by ele.v_elevator_code, ele.v_equipment_code
    </select>

    <!--获取困人记录 麦信数据源-->
    <select id="getElevatorHlsInfoTrappedWithMXData" resultType="java.util.Map">
        SELECT
        ele.v_elevator_code,
        ele.v_address,
        fault.v_fault_id AS v_fault_id,
        fault.dt_report_time AS dt_report_time,
        fault.dt_end_time,
        TIMEDIFF( fault.dt_end_time, fault.dt_report_time ) AS duration_time
        FROM
        tbl_elevator ele
        INNER JOIN tbl_fault fault on fault.v_elevator_id = ele.v_elevator_id
        <where>
            (fault.i_fault_type = 7 or fault.i_fault_type = 8)
            <if test="register_number != null and register_number != ''">
                and ele.v_equipment_code = #{register_number}
            </if>
        </where>
        order by fault.dt_report_time desc
        limit 3
    </select>

    <!--获取前三故障记录 麦信数据源-->
    <select id="getElevatorHlsInfoFaultWithMXData" resultType="java.util.Map">
        SELECT
        ele.v_elevator_code,
        ele.v_address,
        fault.v_fault_id AS v_fault_id,
        fault.dt_report_time AS dt_report_time,
        fault.v_fault_name AS v_fault_name,
        fault.dt_end_time,
        TIMEDIFF( fault.dt_end_time, fault.dt_report_time ) AS duration_time
        FROM
        tbl_elevator ele
        INNER JOIN tbl_fault fault on fault.v_elevator_id = ele.v_elevator_id
        <where>
            fault.i_uncivilized_behavior_flag = 0
            <if test="register_number != null and register_number != ''">
                and ele.v_equipment_code = #{register_number}
            </if>
        </where>
        order by fault.dt_report_time desc
        limit 3
    </select>

    <!--获取故障列表(麦信推送故障)-->
    <select id="searchFaultListWithMXData" resultType="java.util.Map">
        SELECT
        fault.v_fault_id AS v_fault_id,
        ele.v_elevator_id,
        ele.v_elevator_code,
        ele.v_equipment_code as registerNumber,
        ele.v_elevator_name,
        ele.v_address,
        ele.v_village_id as villageId,
        fault.dt_report_time as dt_report_time,
        fault.i_fault_type as i_fault_type,
        fault.v_fault_name as v_fault_name,
        fault.i_status as i_status
        FROM
        tbl_fault fault
        INNER JOIN tbl_elevator ele ON fault.v_elevator_id = ele.v_elevator_id
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id
            AND resource.v_user_id = #{userId}
        </if>
        <where>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                and ele.v_elevator_code like CONCAT('%',#{vElevatorCode},'%')
            </if>
            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and DATE_FORMAT(fault.dt_report_time,'%Y-%m-%d') >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and DATE_FORMAT(fault.dt_report_time,'%Y-%m-%d') <=  #{dtEndTime} ]]>
            </if>
            <if test="iStatus != null">
                and fault.i_status = #{iStatus}
            </if>
            <if test="iFaultType != null and iFaultType != ''">
                and fault.i_fault_type = #{iFaultType}
            </if>
            <if test="villageId != null and villageId != ''">
                and ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
        </where>
        order by fault.dt_report_time desc
    </select>

    <!--获取年检记录-->
    <select id="queryRuiJinAnnualCheckList" resultType="java.util.Map">
        SELECT
        `check`.*,
        ele.v_elevator_name AS elevator_name,
        ele.v_elevator_code AS v_elevator_code,
        ele.v_address AS v_address
        FROM
        `tbl_thrid_party_ruijin_check` `check`
        JOIN tbl_elevator ele ON ele.v_equipment_code = `check`.register_number
        <if test="!isAdminFlag">
            JOIN tbl_sys_user_resource resource ON ele.v_elevator_id = resource.v_resource_id AND resource.v_user_id =
            #{userId}
        </if>
        <where>

            <if test="dtReportTime != null and dtReportTime != ''">
                <![CDATA[  and DATE_FORMAT(`check`.inspect_date,'%Y-%m-%d') >= #{dtReportTime} ]]>
            </if>
            <if test="dtEndTime != null and dtEndTime != ''">
                <![CDATA[ and DATE_FORMAT(`check`.inspect_date,'%Y-%m-%d') <=  #{dtEndTime} ]]>
            </if>
            <if test="overdue != null and overdue != ''">
                AND `check`.overdue = #{overdue}
            </if>
            <if test="villageId != null and villageId != ''">
                AND ele.v_village_id = #{villageId}
            </if>
            <if test="vProjectId != null and vProjectId != ''">
                AND ele.v_project_id = #{vProjectId}
            </if>
            <if test="vElevatorCode != null and vElevatorCode != ''">
                AND ele.v_elevator_code = #{vElevatorCode}
            </if>
        </where>
    </select>

</mapper>
