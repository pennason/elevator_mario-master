<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shmashine.api.dao.TblCameraImageIdentifyMapper">
    <sql id="TABLE_NAME">
        tbl_camera_image_identify
    </sql>
    <sql id="BASE_COLUMNS">
        task_custom_id
        , elevator_id, elevator_code, collect_time, floor, `status`
    </sql>
    <sql id="ALL_COLUMNS">
        <include refid="BASE_COLUMNS"/>,
        id, oss_url, identify_type, identify_status, identify_result, create_time, modify_time
    </sql>
    <sql id="SET_COLUMNS">
        <if test="entity.elevatorId != null and entity.elevatorId != ''">elevator_id = #{entity.elevatorId},</if>
        <if test="entity.elevatorCode != null and entity.elevatorCode != ''">elevator_code = #{entity.elevatorCode},
        </if>
        <if test="entity.collectTime != null and entity.collectTime != ''">collect_time = #{entity.collectTime},</if>
        <if test="entity.floor != null and entity.floor != ''">floor = #{entity.floor},</if>
        <if test="entity.ossUrl != null and entity.ossUrl != ''">oss_url = #{entity.ossUrl},</if>
        <if test="entity.status != null">`status` = #{entity.status},</if>
        <if test="entity.identifyType != null">identify_type = #{entity.identifyType},</if>
        <if test="entity.identifyStatus != null">identify_status = #{entity.identifyStatus},</if>
        <if test="entity.identifyResult != null and entity.identifyResult != ''">identify_result =
            #{entity.identifyResult},
        </if>
    </sql>

    <!-- 查询 -->

    <select id="getById" resultType="com.shmashine.common.entity.TblCameraImageIdentifyEntity">
        SELECT
        <include refid="ALL_COLUMNS"/>
        FROM
        <include refid="TABLE_NAME"/>
        WHERE id = #{id}
    </select>

    <!--根据自定义id获取记录-->
    <select id="getByCustomId" resultType="com.shmashine.common.entity.TblCameraImageIdentifyEntity">
        SELECT
        <include refid="ALL_COLUMNS"/>
        FROM
        <include refid="TABLE_NAME"/>
        WHERE task_custom_id = #{customId}
    </select>

    <select id="listRecentUnIdentify" resultType="com.shmashine.common.entity.TblCameraImageIdentifyEntity">
        SELECT
        <include refid="ALL_COLUMNS"/>
        FROM
        <include refid="TABLE_NAME"/>
        WHERE status = 1 and create_time &gt;= #{date}
        OR (create_time &gt;= #{date} AND modify_time &lt; DATE_ADD(NOW(), INTERVAL -5 MINUTE) AND status = 2)
        LIMIT 512
    </select>

    <select id="listInitRecordHoursAgo" resultType="com.shmashine.common.entity.TblCameraImageIdentifyEntity">
        SELECT
        <include refid="ALL_COLUMNS"/>
        FROM
        <include refid="TABLE_NAME"/>
        WHERE status = 0 and create_time &lt; #{date}
        ORDER BY id DESC
        LIMIT 15
    </select>

    <!--抠图配置-根据故障类型获取图片抠图配置-->
    <select id="getImageMattingConfigByFaultType"
            resultType="com.shmashine.api.service.elevator.DO.ImageRecognitionMattingConfigDO">
        SELECT *
        FROM image_recognition_matting_config
        WHERE elevator_code = #{elevatorCode}
          AND fault_types LIKE concat('%', #{faultType}, '%') limit 1
    </select>

    <!--抠图配置-更新配置实际坐标点-->
    <update id="updateImageMattingConfig">
        update
            image_recognition_matting_config
        set real_coordinates = #{realCoordinates}
        where id = #{id}
    </update>

    <update id="update" parameterType="com.shmashine.common.entity.TblCameraImageIdentifyEntity">
        UPDATE
        <include refid="TABLE_NAME"/>
        <set>
            <include refid="SET_COLUMNS"/>
        </set>
        <where>
            <if test="entity.id != null">
                AND id = #{entity.id}
            </if>
            <if test="entity.taskCustomId != null and entity.taskCustomId != ''">
                AND task_custom_id = #{entity.taskCustomId}
            </if>
        </where>
    </update>

    <update id="updateStatusToIdentifying" parameterType="java.lang.Long">
        UPDATE
        <include refid="TABLE_NAME"/>
        SET status = 2
        WHERE id in
        <foreach collection="ids" index="index" item="id" separator="," open="(" close=")">
            #{id}
        </foreach>
    </update>

    <insert id="save" parameterType="com.shmashine.common.entity.TblCameraImageIdentifyEntity">
        INSERT INTO
        <include refid="TABLE_NAME"/>
        (<include refid="BASE_COLUMNS"/>)
        VALUES
        (#{entity.taskCustomId}, #{entity.elevatorId}, #{entity.elevatorCode}, #{entity.collectTime}, #{entity.floor},
        #{entity.status})
        ON DUPLICATE KEY UPDATE
        <trim suffixOverrides=",">
            <include refid="SET_COLUMNS"/>
        </trim>
    </insert>

</mapper>